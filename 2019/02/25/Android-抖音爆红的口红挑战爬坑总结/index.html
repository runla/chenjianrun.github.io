<!DOCTYPE html>
<html lang="zh-CN">

  
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="author" content="è‘£æ²…é‘«, yuanxin.me@gmail.com">
  
  
  
  <title>Android æŠ–éŸ³çˆ†çº¢çš„å£çº¢æŒ‘æˆ˜çˆ¬å‘æ€»ç»“ | ï¿½Â¼ï¿½ï¿½ï¿½ï¿½ï¿½Ë²ï¿½ï¿½ï¿½</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="Android,å£çº¢æœº,æ€»ç»“,">
  

  <script>
    console.log('\n%c Hexo-theme-bmw v4.0 ' + '%c ğŸ‰ https://github.com/dongyuanxin/theme-bmw ğŸ‰\n' + '\n%c View demo online ' + '%c ğŸ” https://godbmw.com/ ğŸ”  \n' , 'color: #fadfa3; background: #030307; padding:3px 0;', '', 'color: #fadfa3; background: #030307; padding:3px 0;', '');
  </script>

  

  

  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/icon/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">

  <script src="/js/util.js"></script>
<script src="/js/valine.min.js"></script>

  

  
    <link href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js" async></script>
  

  
    <link href="https://cdn.bootcss.com/social-share.js/1.0.16/css/share.min.css" rel="stylesheet">
  
  
  <script src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js" async></script>
  
  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.0/dist/av-min.js"></script>
  

</head>

  <body>

    

    <div id="app">

      <div class="header-wrap">
  <header>
    <div class="site-brand">
      <div class="site-title">
        <a href="/">GODBMW.com</a>
      </div>
    </div>
    <nav class="site-navigation">
      <ul class="nav-menu">
      
        <li class="nav-item" data-path="/">
          
            <a href="/" target="_self">
              ä¸»é¡µ
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/archives/">
          
            <a href="/archives/" target="_self">
              å½’æ¡£
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/categories/">
          
            <a href="/categories/" target="_self">
              åˆ†ç±»
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/tags/">
          
            <a href="/tags/" target="_self">
              æ ‡ç­¾
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/friends/">
          
            <a href="/friends/" target="_self">
              å‹é“¾
            </a>
          
        </li>
      
        <li class="nav-item" data-path="/about/">
          
            <a href="/about/" target="_self">
              å…³äº
            </a>
          
        </li>
      
        <li class="nav-item" data-path>
          
            <a href="javascript:void(0);" v-else>æŠ“åˆ°æˆ‘</a>
            <ul class="nav-menu--dropdown">
              
                <li>
                  <a href="https://github.com/dongyuanxin" target="_blank">
                    Github
                  </a>
                </li>
              
                <li>
                  <a href="https://www.zhihu.com/people/godbmw/activities" target="_blank">
                    çŸ¥ä¹
                  </a>
                </li>
              
            </ul>
          
        </li>
      
      </ul>
    </nav>
    <i class="iconfont icon-menu"></i>
  </header>
</div>

<script>
  let links = document.querySelectorAll('.nav-item');
  for(let link of links){
    let childrenLink = link.querySelector('ul');
    link.addEventListener('mouseenter', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown active";
      }
    })
    link.addEventListener('mouseleave', () => {
      if(childrenLink) {
        childrenLink.className = "nav-menu--dropdown";
      }
    })
  }
  let rootRealPath = getRealPath(window.location.pathname, true);
  for(let link of links) {
    let linkPath = link.getAttribute("data-path");
    if(linkPath && getRealPath(linkPath, true) === rootRealPath) {
      link.className = "nav-item hover";
    }
  }

  let iconMenu = document.querySelector("i.iconfont.icon-menu"),
    iconMenuClicked = false;
  let navDOM = document.querySelector("nav.site-navigation");
  iconMenu.addEventListener("click", () => {
    iconMenuClicked 
      ? navDOM.className = "site-navigation active"
      : navDOM.className = "site-navigation";
    iconMenuClicked = !iconMenuClicked;
  })
</script>

      








<div class="container post-index">

  

<div class="post">
  <h1 class="article-title">
    <span>Android æŠ–éŸ³çˆ†çº¢çš„å£çº¢æŒ‘æˆ˜çˆ¬å‘æ€»ç»“</span>
  </h1>
  <div class="article-top-meta">
    <span>
      å‘å¸ƒ : 
      2019-02-25
    </span>
    
    
      <span>
        æµè§ˆ : <span class="article-timer" data-identity="Android-æŠ–éŸ³çˆ†çº¢çš„å£çº¢æŒ‘æˆ˜çˆ¬å‘æ€»ç»“"></span>
      </span>
    
  </div>

  

  <div class="article-content">
    <div class="markdown-body">
      <h1 id="é¡¹ç›®èƒŒæ™¯"><a href="#é¡¹ç›®èƒŒæ™¯" class="headerlink" title="é¡¹ç›®èƒŒæ™¯"></a>é¡¹ç›®èƒŒæ™¯</h1><p>ä»Šå¹´ï¼Œç›¸ä¿¡å¾ˆå¤šäººéƒ½ä¼šåœ¨å„ä¸ªå•†åœºæˆ–è€…æ˜¯ç”µå½±é™¢ä¸­å¯ä»¥çœ‹åˆ°å„ç§å¨ƒå¨ƒæœºã€å¹¸è¿ç›’å­ã€å£çº¢æŒ‘æˆ˜ç­‰ç­‰ç±»ä¼¼æœºå™¨ã€‚åœ¨æŠ–éŸ³ä¸Šã€Šå£çº¢æŒ‘æˆ˜ã€‹è¿™æ¬¾æœºå­ä¹Ÿæ˜¯ç«çš„ä¸€å¡Œç³Šæ¶‚ï¼Œä½ åªè¦èŠ± 10 å—é’±å°±æœ‰å¯èƒ½èµ¢èµ°ä¸€ä¸ª  YSL å£çº¢ï¼Œæƒ³æƒ³å°±è§‰å¾—å¾ˆæœ‰è¯±æƒ‘åŠ›ã€‚æˆ–è®¸è¿™äº›æœºå™¨è¢«ç¨‹åºå‘˜ä¸€ç§å°±çŸ¥é“å…¶ä¸­çš„çŒ«è…»ï¼Œä½†æ˜¯è¿™ä¸ªæœºå™¨ç„å‡†çš„æ˜¯é‚£äº›å®¹æ˜“å†²åŠ¨æ¶ˆè´¹çš„æ¶ˆè´¹è€…ï¼Œæ¯”å¦‚æƒ…ä¾£ã€å¥³ç”Ÿã€å¸¦å°å­©çš„å¤§äººï¼›åƒç¨‹åºå‘˜è¿™ä¹ˆå¥‡è‘©çš„ç”Ÿç‰©ï¼Œä¸€èˆ¬éƒ½æ˜¯ç›´æ¥è¢«æ— è§†çš„å“ˆå“ˆã€‚</p>
<p>ç„¶åå‘¢ï¼Œæˆ‘ä»¬å…¬å¸å°±æ˜¯ä¸ºè¿™äº›è®¾å¤‡çš„æ­£å¸¸è¿è¡Œæä¾›è§£å†³æ–¹æ¡ˆçš„ã€‚å› æ­¤æ‰æœ‰æˆ‘ä»Šå¤©çš„çˆ¬å‘æ€»ç»“ï¼Œå“ˆå“ˆå“ˆå“ˆå“ˆâ€¦..</p>
<p>æˆ‘ä»¬æä¾›çš„è§£å†³æ–¹æ¡ˆæ˜¯è¿™æ ·çš„ï¼Œåœ¨ä¸€ä¸ªé—¨åº—é‡Œé¢ä¼šåŒ…å«å¦‚ä¸‹çš„è®¾å¤‡ï¼šå¨ƒå¨ƒæœºã€å£çº¢æŒ‘æˆ˜ã€æ’è¡Œæ¦œã€ä¸­æ§ï¼Œå½“ç„¶å…¶ä¸­è¿˜æœ‰æˆ‘ä»¬çš„åå°æœåŠ¡ã€‚é‚£ä¹ˆé¦–å…ˆæˆ‘ä¼šå…ˆä»‹ç»ä¸€ä¸‹æ•´ä¸ªç³»ç»Ÿçš„æ¶æ„ä»¥åŠå„ä¸ªè®¾å¤‡çš„èŒè´£ï¼š</p>
<ul>
<li>ç³»ç»Ÿæ¶æ„å›¾</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/8/1682ace09efc6497?w=653&amp;h=478&amp;f=png&amp;s=22131" alt="é—¨åº—ç³»ç»Ÿç»“æ„å›¾.png"></p>
<ul>
<li>æœåŠ¡åå°<ul>
<li>æœåŠ¡åå°ä¸å±äº Android è¿™ç«¯è´Ÿè´£çš„ï¼Œå› æ­¤ä¸éœ€è¦å»å…³æ³¨å¤ªå¤šï¼ŒæœåŠ¡åå°ç›¸å¯¹äºé—¨åº—è®¾å¤‡è€Œè¨€ï¼Œå®ƒçš„ä¸€ä¸ªèŒè´£æ˜¯è´Ÿè´£ç»™æœºå™¨å‘é€ä¸Šåˆ†è´¨é‡ï¼Œç›‘æµ‹è®¾å¤‡çŠ¶æ€ï¼ŒåŠä¸€äº›å…¶ä»–çš„ä¿¡æ¯ã€‚</li>
</ul>
</li>
<li>ä¸­æ§ï¼ˆæœ¬åœ°æœåŠ¡ï¼šä¸è¿æ¥å¤–ç½‘ï¼‰ï¼šè¿™ä¸ªä¸­æ§ä¹Ÿæ˜¯ä¹Ÿ Android è®¾å¤‡ï¼Œå®ƒçš„åŠŸèƒ½æœ‰ä¸¤ä¸ªï¼š<ol>
<li>æ’è¡Œæ¦œï¼šç”¨æ¥æ¥æ”¶å¨ƒå¨ƒæœºä¸­å‘é€è¿‡æ¥çš„ç”¨æˆ·å¤¹ä¸­å¨ƒå¨ƒçš„ä¿¡æ¯ï¼Œå¹¶æœ€åå°†å…¶æ˜¾ç¤ºåœ¨æ’è¡Œæ¦œä¸Šã€‚</li>
<li>èµ„æºåˆ†å‘ä¸­æ§ï¼šä½œä¸ºèµ„æºçš„åˆ†å‘ä¸­å¿ƒï¼Œä¸­æ§éœ€è¦åˆ†å‘ apk å®‰è£…åŒ…ã€å›¾ç‰‡ã€</li>
</ol>
</li>
<li>å¨ƒå¨ƒæœºï¼šè¿™ä¸€å—å…¶å®åŒ…å«äº†ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯ Android è®¾å¤‡ï¼Œå¦å¤–ä¸€ä¸ªç¡¬ä»¶è®¾å¤‡ã€‚<ol>
<li>Android è®¾å¤‡ä¸»è¦æ˜¯ç”¨æ¥æ˜¾ç¤º bannerã€å¤„ç†æœåŠ¡å™¨æ•°æ®ï¼ˆä¾‹å¦‚ï¼šä¸Šåˆ†ï¼‰ã€å¯¹æ¥ä¸­æ§ï¼ˆèµ„æºæ›´æ–°ã€æ•°æ®åé¦ˆç­‰ï¼‰ã€å¯¹æ¥ç¡¬ä»¶è®¾å¤‡</li>
<li>ç¡¬ä»¶è®¾å¤‡ä¸»è¦æ˜¯å¤„ç†ç”¨æˆ·ä¸Šåˆ†ã€å‡ºç¤¼ã€å¿ƒè·³ç­‰ä¿¡æ¯ï¼Œå¹¶å°†è¿™äº›ä¿¡æ¯äº¤ç»™ Android è®¾å¤‡å¤„ç†ã€‚</li>
</ol>
</li>
<li>å£çº¢æŒ‘æˆ˜ï¼šå…³äºå£çº¢æŒ‘æˆ˜è¿™ä¸ªè®¾å¤‡å¯ä»¥åˆ’åˆ†ä¸º 3 ä¸ªæ¨¡å—ï¼Œåˆ†åˆ«ä¸ºè§ç¼æ’é’ˆæ¸¸æˆã€å¸¸è§„ç¨‹åºæ¨¡å—ã€ç¡¬ä»¶æ¨¡å—<ol>
<li>å…³äºè§ç¼æ’é’ˆçš„è¿™ä¸ªæ¸¸æˆæ˜¯ç”¨ç™½é¹­å¼•æ“åšçš„ï¼Œæœ€åä»¥ h5 çš„å½¢å¼åµŒå…¥åˆ° APP ä¸­ï¼Œä¸»è¦è´Ÿè´£æ¸¸æˆçš„ä¸»é€»è¾‘ä»¥åŠå’Œç¨‹åºä¸»æ¨¡å—è¿›è¡Œæ¸¸æˆé€»è¾‘æ•°æ®çš„åé¦ˆã€‚</li>
<li>å¸¸è§„æ¨¡å—ä¸»è¦æ˜¯æœ‰å¤„ç†æœåŠ¡åå°çš„æ•°æ®ã€å¯¹æ¥ç¡¬ä»¶æ¨¡å—ï¼ˆæ ¼å­é€‰ä¸­ã€æ‰“å¼€æ ¼å­ç­‰ï¼‰ã€å¯¹æ¥æ¸¸æˆï¼ˆå¯åŠ¨æ¸¸æˆã€æ¸¸æˆç»“æœåé¦ˆç­‰ï¼‰ã€ç‰©æ–™åå°ç®¡ç†ã€‚</li>
</ol>
</li>
<li>rocketï¼šè¿™ä¸ªç¨‹åºæœ‰ç‚¹ç‰¹æ®Šï¼Œå› ä¸ºç”¨æˆ·æ˜¯çœ‹ä¸åˆ°å®ƒçš„ï¼Œåœ¨å‡ºå‚çš„æ—¶å€™ï¼Œè¿™ä¸ªç¨‹åºå°±è¢«å†™è¿›å»äº†ï¼Œé‚£ä¹ˆå®ƒè´Ÿè´£çš„å·¥ä½œå¦‚ä¸‹ï¼š<ol>
<li>å±è”½è®¾å¤‡çš„ systemui ç¨‹åºå’Œ launcher ç¨‹åºï¼Œé˜²æ­¢ç”¨æˆ·åšä¸€äº›éæ³•çš„æ“ä½œã€‚</li>
<li>æ£€æµ‹ U ç›˜æ˜¯å¦æ’å…¥ï¼Œç„¶åç§»åŠ¨æˆ–è€…è´Ÿè´£åˆ¶å®šæ–‡ä»¶ï¼ˆapk å®‰è£…åŒ…ã€ipconfig.json æ–‡ä»¶ã€ä¸‰å…ƒç»„é…èµ„æ–‡ä»¶config.jsonã€h5 èµ„æºæ–‡ä»¶ç­‰ï¼‰</li>
<li>æ¥æ”¶å¹¿æ’­ï¼Œè‡ªåŠ¨å®‰è£…æˆ–è€…æ›´æ–°å¨ƒå¨ƒæœºæˆ–è€…å£çº¢æŒ‘æˆ˜ç¨‹åº</li>
</ol>
</li>
</ul>
<hr>
<h1 id="è¦è§£å†³çš„é—®é¢˜"><a href="#è¦è§£å†³çš„é—®é¢˜" class="headerlink" title="è¦è§£å†³çš„é—®é¢˜"></a>è¦è§£å†³çš„é—®é¢˜</h1><h2 id="åŒæ­¥åŠ è½½èµ„æº"><a href="#åŒæ­¥åŠ è½½èµ„æº" class="headerlink" title="åŒæ­¥åŠ è½½èµ„æº"></a>åŒæ­¥åŠ è½½èµ„æº</h2><blockquote>
<p>å…³äºèµ„æºåŒæ­¥çš„ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆç†ä¸€ä¸‹æˆ‘ä»¬éœ€è¦åŒæ­¥çš„èµ„æºæœ‰å“ªäº›ï¼Œè¿™äº›èµ„æºåˆ†åˆ«ä¸ºï¼š apk å®‰è£…åŒ…ã€å›¾ç‰‡ã€h5 ç›¸å…³çš„ index èµ„æºã€‚</p>
</blockquote>
<h3 id="èµ„æºæ›´æ–°çš„æ–¹å¼"><a href="#èµ„æºæ›´æ–°çš„æ–¹å¼" class="headerlink" title="èµ„æºæ›´æ–°çš„æ–¹å¼"></a>èµ„æºæ›´æ–°çš„æ–¹å¼</h3><p>å…³äºæ›´æ–°çš„æ–¹å¼ï¼Œè¿™é‡Œå…¶å®å°±æœ‰ä¸€ä¸ªæ¯”è¾ƒå‘çš„åœ°æ–¹äº†ï¼Œä¸€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¬é€‰æ‹©çš„èµ„æºæ›´æ–°æ–¹å¼æ¯”è¾ƒå‚»ï¼Œç›´æ¥ä½¿ç”¨ websocket è¿›è¡Œèµ„æºæ›´æ–°çš„ï¼Œä¸€å¼€å§‹çš„æ—¶å€™åªæœ‰ä¸€ä¸ªè®¾å¤‡è¿›è¡Œè¿æ¥ï¼Œé—®é¢˜å€’æ˜¯ä¸å¤§ï¼Œä½†æ˜¯åæ¥å‘ç°å¤šå°è®¾å¤‡è¿æ¥åŒæ—¶æ›´æ–°èµ„æºçš„æ—¶å€™é—®é¢˜ç‰¹åˆ«å¤§ï¼Œè¿æ¥ç»å¸¸æ–­å¼€ï¼Œå¯¼è‡´èµ„æºæ›´æ–°å¤±è´¥ã€‚é‚£ä¹ˆè¿™é‡Œæ˜¯æˆ‘é‡åˆ°çš„ç¬¬ä¸€ä¸ªå‘ã€‚å‘ç°è¿™ä¸ªå‘ä¹‹åå‘¢ï¼Œæˆ‘çš„é€‰æ‹©èµ„æºæ›´æ–°çš„æ–¹å¼å°±æ›´æ”¹ä¸ºï¼šNanoHttpdã€‚NanoHttpd æ˜¯ä¸€ä¸ªå¼€æºåº“ï¼Œæ˜¯ç”¨ Java å®ç°çš„ï¼Œå®ƒå¯ä»¥åœ¨ Android è®¾å¤‡ä¸Šå»ºç«‹ä¸€ä¸ªè½»é‡çº§çš„ web serverã€‚å…¶å®åœ¨ Android è®¾å¤‡ä¸Šåˆ›å»ºä¸€ä¸ªè½»é‡çº§çš„ web server æ‰æ˜¯æˆ‘ä»¬ä¸€å¼€å§‹å°±åº”è¯¥è¦é€‰æ‹©çš„æ–¹å‘ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿé¦–å…ˆ NanoHttpd çš„ä½¿ç”¨æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦å‡ è¡Œä»£ç å°±å¯ä»¥å®ç°ä¸€ä¸ª web server äº†ï¼›å…¶æ¬¡å‘¢ï¼ŒNanoHttpd æ˜¯æ¯”è¾ƒç¨³å®šçš„ï¼Œç›¸å¯¹äºæˆ‘ä»¬æ‰‹åŠ¨ä½¿ç”¨ websocket å»å®ç°ä¸€ä¸ªèµ„æºåˆ†å‘è¦ç¨³å®šå¤ªå¤šäº†ã€‚</p>
<p>é‚£ä¹ˆåœ¨æˆ‘ä»¬é€‰æ‹©äº†èµ„æºçš„æ›´æ–°æ–¹å¼ä¹‹åï¼Œæœ‰å¦å¤–ä¸€ä¸ªé—®é¢˜æµ®å‡ºæ°´é¢äº†ï¼Œå…³äºæœåŠ¡å™¨çš„ IP åœ°å€ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå…³äº Android è®¾å¤‡è¿æ¥ä¸Šç§»åŠ¨äº’è”ç½‘æˆ–è€… WiFi çš„æ—¶å€™éƒ½ä¼šè¢«è‡ªåŠ¨åˆ†é…ä¸€ä¸ª IP åœ°å€ï¼Œå› æ­¤è¿™ä¸ª IP åœ°å€æ˜¯ä¼šå˜åŒ–çš„ï¼Œæˆ‘ä»¬çš„è®¾å¤‡åœ¨æ¯å¤©æ™šä¸Šéƒ½ä¼šå…³æœºï¼Œç„¶ååœ¨ç¬¬äºŒå¤©å¼€å¯é‡å¯çš„æ—¶å€™åˆä¼šè¢«åˆ†é…åˆ°ä¸€ä¸ªæ–°çš„ IP åœ°å€ï¼Œå› æ­¤æœåŠ¡å™¨çš„ IP åœ°å€æ˜¯ä¸€ç›´åœ¨å˜åŒ–çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯æƒ³åŠæ³•æŠŠæŸä¸ªè®¾å¤‡çš„ IP åœ°å€ç»™å›ºå®šä¸‹æ¥ã€‚é‚£ä¹ˆæ¥ä¸‹æ¥å°±æ¥è®²è®²å…³äº NanoHttpd åˆ›å»ºè½»é‡çº§çš„ web server å’Œå¦‚ä½•è§£å†³ IP å˜åŒ–çš„é—®é¢˜ã€‚</p>
<h4 id="NanoHttpd-å®ç°-web-server"><a href="#NanoHttpd-å®ç°-web-server" class="headerlink" title="NanoHttpd å®ç° web server"></a>NanoHttpd å®ç° web server</h4><ul>
<li>NanoHttpd é¡¹ç›®åœ°å€<ul>
<li><a href="https://github.com/NanoHttpd/nanohttpd" target="_blank" rel="noopener">https://github.com/NanoHttpd/nanohttpd</a></li>
</ul>
</li>
<li><p>gradle ä¾èµ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;org.nanohttpd:nanohttpd-webserver:2.3.1&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®ç°æ–¹å¼</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">File resourceDir = new File(Environment.getExternalStorageDirectory(), &quot;myRootDir&quot;);</span><br><span class="line">SimpleWebServer httpServer = new SimpleWebServer(null, 18103, resourceDir, true, &quot;*&quot;);</span><br><span class="line">httpServer.start(NanoHTTPD.SOCKET_READ_TIMEOUT, true);</span><br></pre></td></tr></table></figure>
<ul>
<li>SimpleWebServer æ„é€ å‡½æ•°çš„å‚æ•°<ul>
<li>hostï¼šæœåŠ¡å™¨ ip åœ°å€</li>
<li>portï¼šç«¯å£å·ï¼ˆå–å€¼èŒƒå›´ï¼š1024~65535ï¼‰</li>
<li>wwwrootï¼šæ”¾ç½®é™æ€èµ„æºçš„æ ¹ç›®å½•</li>
<li>quietï¼šæ˜¯å¦ä¸ºå®‰é™æ¨¡å¼</li>
<li>corsï¼š</li>
</ul>
</li>
<li>è®¿é—®æ–¹å¼<ul>
<li>åœ¨åŒä¸ªå±€åŸŸç½‘ä¸‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è¾“å…¥åœ°å€ï¼š<a href="http://10.0.0.34:18103ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¿é—®åˆ°æˆ‘ä»¬æœåŠ¡å™¨ä¸­çš„èµ„æºäº†ï¼Œå½“ç„¶ç›®å‰å®ç°çš„æœåŠ¡å™¨æ˜¯é™æ€çš„ï¼Œåªèƒ½å¤„ç†" target="_blank" rel="noopener">http://10.0.0.34:18103ï¼Œæˆ‘ä»¬å°±å¯ä»¥è®¿é—®åˆ°æˆ‘ä»¬æœåŠ¡å™¨ä¸­çš„èµ„æºäº†ï¼Œå½“ç„¶ç›®å‰å®ç°çš„æœåŠ¡å™¨æ˜¯é™æ€çš„ï¼Œåªèƒ½å¤„ç†</a> get èµ„æºè¯·æ±‚ï¼Œä¸èƒ½å¤Ÿå¤„ç† postã€put ç­‰å…¶ä»–è¯·æ±‚ï¼Œç›®å‰æ˜¯å¤„ç†ä¸äº†çš„ï¼Œå¦‚æœéœ€è¦è‡ªå·±å†å¤„ç† post å’Œ put ç­‰å…¶ä»–çš„è¯·æ±‚çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥è‡ªå·±å» <a href="https://github.com/NanoHttpd/nanohttpd" target="_blank" rel="noopener">é¡¹ç›®åŸåœ°å€</a> ä¸­å‚è€ƒå®ƒçš„ç”¨æ³•å»å®ç°ï¼Œåœ¨è¿™é‡Œå°±ä¸å¤šè®²äº†ã€‚</li>
</ul>
</li>
</ul>
<h4 id="è§£å†³-IP-å˜åŒ–çš„é—®é¢˜"><a href="#è§£å†³-IP-å˜åŒ–çš„é—®é¢˜" class="headerlink" title="è§£å†³ IP å˜åŒ–çš„é—®é¢˜"></a>è§£å†³ IP å˜åŒ–çš„é—®é¢˜</h4><p>åœ¨ Android è®¾å¤‡ä¸­ï¼Œå®ƒçš„ä¸€ä¸ª IP åœ°å€æ˜¯ä¼šå˜åŒ–çš„ï¼Œè€Œä¸”æ¯ä¸ªé—¨åº—éƒ½ä¼šæœ‰ä¸€ä¸ªè‡ªå·±çš„å†…éƒ¨ä¸­æ§æœºï¼Œé‚£ä¹ˆæˆ‘ä»¬æ˜¯å¿…é¡»è¦å¤„ç† IP åœ°å€å˜åŒ–çš„è¿™ä¸ªé—®é¢˜çš„ã€‚æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆæœ‰å¦‚ä¸‹ä¸¤ä¸ªæ­¥éª¤ï¼š</p>
<ol>
<li>åœ¨è·¯ç”±å™¨ä¸­æ ¹æ® Mac åœ°å€ï¼Œä¸ºé—¨åº—å†…çš„ä¸­æ§è®¾å¤‡è®¾ç½®å›ºå®šçš„ IP åœ°å€</li>
<li>ä¸ºæ¯ä¸ªå¨ƒå¨ƒæœºå’Œå£çº¢æŒ‘æˆ˜è®¾å¤‡æä¾›ä¸€ä¸ª IP åœ°å€çš„é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶é‡Œé¢æœ‰é—¨åº—ä¸­æ§çš„ IP åœ°å€ä¿¡æ¯ï¼Œæ”¾åœ¨ U ç›˜çš„æŒ‡å®šç›®å½•ä¸‹ï¼Œä½†æ’å…¥è®¾å¤‡çš„æ—¶å€™ï¼Œç”± Rocket ç¨‹åºå°†æ–‡ä»¶ä» U ç›˜ä¸­å°†é…ç½®æ–‡ä»¶ copy åˆ°è®¾å¤‡çš„åˆ¶å®šç›®å½•ä¸‹ï¼Œè®¾å¤‡æ¯æ¬¡å¯åŠ¨çš„æ—¶å€™éƒ½éœ€è¦å…ˆè¯»å–é…ç½®æ–‡ä»¶ï¼Œå†è¿æ¥æœ¬åœ°çš„æœåŠ¡å™¨ã€‚</li>
</ol>
<h3 id="èµ„æºä»€ä¹ˆæ—¶å€™æ›´æ–°"><a href="#èµ„æºä»€ä¹ˆæ—¶å€™æ›´æ–°" class="headerlink" title="èµ„æºä»€ä¹ˆæ—¶å€™æ›´æ–°"></a>èµ„æºä»€ä¹ˆæ—¶å€™æ›´æ–°</h3><p>å…³äºèµ„æºæ›´æ–°çš„ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦æ˜ç¡®æˆ‘ä»¬éœ€è¦æ›´æ–°çš„èµ„æºæœ‰å“ªäº›ä»¥åŠæˆ‘ä»¬éœ€è¦æ›´æ–°çš„æ–¹å¼ã€‚</p>
<h4 id="æ›´æ–°çš„èµ„æº"><a href="#æ›´æ–°çš„èµ„æº" class="headerlink" title="æ›´æ–°çš„èµ„æº"></a>æ›´æ–°çš„èµ„æº</h4><ul>
<li>Resource.json</li>
<li>apk åŒ…</li>
<li>å¨ƒå¨ƒæœºä¸­çš„æ˜¾ç¤ºå™¨è½®æ’­å›¾</li>
<li>å¨ƒå¨ƒæœºä¸­æ˜¾ç¤º banner çš„ h5 èµ„æº<h4 id="æ›´æ–°çš„é…ç½®æ–‡ä»¶"><a href="#æ›´æ–°çš„é…ç½®æ–‡ä»¶" class="headerlink" title="æ›´æ–°çš„é…ç½®æ–‡ä»¶"></a>æ›´æ–°çš„é…ç½®æ–‡ä»¶</h4></li>
<li><p>å…³äºæˆ‘ä»¬èµ„æºè·Ÿæ–°çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¿å­˜åœ¨ Resource.json è¿™ä¸ªæ–‡ä»¶å¤¹é‡Œé¢çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¯éš” 5min å°±ä»ä¸­æ§æœåŠ¡ç«¯ï¼ˆå±€åŸŸç½‘å†…ï¼‰è·å– Resource.jsonï¼Œç„¶åæ¯ä¸ªç±»å‹çš„èµ„æºå°±æ ¹æ®å†™åœ¨ Resource.json ä¸­çš„æ•°æ®è¿›è¡Œåˆ¤æ–­ã€‚é‚£ä¹ˆå†™å…¥ Resource.json æ–‡ä»¶ä¸­çš„å®ç°åŠå…·ä½“å†…å®¹å¦‚ä¸‹ï¼š</p>
<ol>
<li><p>èµ„æºçš„ ResList model</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">public class ResListModel &#123;</span><br><span class="line">    // å¨ƒå¨ƒæœº banner çš„ h5 èµ„æºï¼ˆindex.htmlç­‰æ–‡ä»¶ï¼‰</span><br><span class="line">    public HashMap&lt;String, String&gt; bannerFiles = new HashMap();</span><br><span class="line">    // é—¨åº—ä¸­æ‰€æœ‰å¨ƒå¨ƒæœºéƒ½ä¼šæ˜¾ç¤ºçš„è½®æ’­å›¾</span><br><span class="line">    // key ä¸º å›¾ç‰‡çš„ hash å€¼</span><br><span class="line">    // value ä¸ºå›¾ç‰‡çš„åœ¨æœåŠ¡å™¨ä¸­çš„ç›¸å¯¹è·¯å¾„</span><br><span class="line">    public HashMap&lt;String, String&gt; PublicFiles = new HashMap();</span><br><span class="line">    // é—¨åº—ä¸­ç‰¹å®šå¨ƒå¨ƒæœºçš„ç§æœ‰æ˜¾ç¤ºè½®æ’­å›¾</span><br><span class="line">    // key ä¸ºè®¾å¤‡çš„ id</span><br><span class="line">    // value ä¸ºå›¾ç‰‡å›¾ç‰‡çš„ hash åŠè·¯å¾„ä¿¡æ¯ï¼ˆå¯¹åº” PublicFilesï¼‰</span><br><span class="line">    public HashMap&lt;String, HashMap&lt;String, String&gt;&gt; PrivateFiles = new HashMap();</span><br><span class="line">    // æ›´æ–°çš„ apk è·¯å¾„</span><br><span class="line">    public String UpdateApk;</span><br><span class="line">    // æ›´æ–°çš„ apk åŒ…å</span><br><span class="line">    public String UpdateApkPackageName;</span><br><span class="line">    // æ›´æ–°çš„ apk ç‰ˆæœ¬å</span><br><span class="line">    public String UpdateApkVersion;</span><br><span class="line">    // æ›´æ–°çš„ apk ç‰ˆæœ¬å·</span><br><span class="line">    public int UpdateApkVersionCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å†™å…¥åˆ° Resourse.json æ–‡ä»¶</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ResListModel res = new ResListModel();</span><br><span class="line">// ç•¥è¿‡æ·»åŠ æ•°æ®çš„è¿‡ç¨‹</span><br><span class="line">...;</span><br><span class="line">File resourceFile = new File(baseDir, &quot;Resource.json&quot;);</span><br><span class="line">RandomAccessFile out = new RandomAccessFile(resourceFile, &quot;rw&quot;);</span><br><span class="line">byte[] json = JsonStream.serialize(res).getBytes(&quot;utf-8&quot;);</span><br><span class="line">out.setLength(json.length);</span><br><span class="line">out.write(json);</span><br><span class="line">out.close();</span><br></pre></td></tr></table></figure>
</li>
<li><p>Resourse.json çš„å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;PrivateFiles&quot;:&#123;&#125;,</span><br><span class="line">    &quot;PublicFiles&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;1A7D3394A6F10D3668FB29D8CCA1CA8B&quot;:&quot;Public/timg.jpg&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">    &quot;UpdateApk&quot;:null,</span><br><span class="line">    &quot;UpdateApkPackageName&quot;:null,</span><br><span class="line">    &quot;UpdateApkVersion&quot;:null,</span><br><span class="line">    &quot;UpdateApkVersionCode&quot;:0,</span><br><span class="line">    &quot;bannerFiles&quot;:</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C609D70832710E3DCF0FB88918113B18&quot;:&quot;banner/Resource.json&quot;,</span><br><span class="line">            &quot;FC1CF2C83E898357E1AD60CEF87BE6EB&quot;:&quot;banner/app.8113390c.js&quot;,</span><br><span class="line">            &quot;27FBF214DF1E66D0307B7F78FEB8266F&quot;:&quot;banner/manifest.json&quot;,</span><br><span class="line">            &quot;A192A95BFF57FF326185543A27058DE5&quot;:&quot;banner/index.html&quot;,</span><br><span class="line">            &quot;61469B10DBD17FDEEB14C35C730E03C7&quot;:&quot;banner/app.8113390c.css&quot;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
</ul>
<h4 id="èµ„æºå›¾ç‰‡å’Œ-banner-çš„èµ„æºæ–‡ä»¶çš„æ›´æ–°"><a href="#èµ„æºå›¾ç‰‡å’Œ-banner-çš„èµ„æºæ–‡ä»¶çš„æ›´æ–°" class="headerlink" title="èµ„æºå›¾ç‰‡å’Œ banner çš„èµ„æºæ–‡ä»¶çš„æ›´æ–°"></a>èµ„æºå›¾ç‰‡å’Œ banner çš„èµ„æºæ–‡ä»¶çš„æ›´æ–°</h4><ul>
<li>å…³äºå›¾ç‰‡å’Œ banner çš„èµ„æºæ–‡ä»¶çš„æ›´æ–°æ–¹å¼æ˜¯ç±»ä¼¼çš„ï¼Œåªæ˜¯å­˜æ”¾çš„è·¯å¾„ä¸åœ¨åŒä¸€ä¸ªç›®å½•ä¸‹è€Œå·²ã€‚é‚£ä¹ˆå¯¹è¿™ç±»èµ„æºçš„æ›´æ–°ï¼Œæˆ‘ä»¬æ˜¯é€šè¿‡æŠ€æœ¯èµ„æºçš„ hash å€¼å’Œæ–‡ä»¶åæ¥è¿›è¡Œåˆ¤æ–­çš„ã€‚å¨ƒå¨ƒæœºæˆ–è€…å£çº¢æŒ‘æˆ˜è®¾å¤‡ä¼šæ¯éš” 5min ä»ä¸­æ§ä¸­è·å– Resourse.json æ–‡ä»¶ï¼Œç„¶åå–å‡º ResListModelï¼ŒResListModel åœ¨ä¹‹å‰ä»‹ç»è¿‡äº†ï¼Œæ˜¯ä¿å­˜èµ„æºæ›´æ–°çš„é…ç½®æ–‡ä»¶ï¼›ä¹‹åæˆ‘ä»¬ä»ä¸­å–å‡ºç›¸å¯¹äºçš„é…ç½®ï¼Œé¦–å…ˆæ ¹æ®æ–‡ä»¶ååˆ¤æ–­è¯¥æ–‡ä»¶æ˜¯å¦å·²ç»å­˜åœ¨æœ¬åœ°äº†ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç›´æ¥æ·»åŠ åˆ°èµ„æºæ›´æ–°çš„åˆ—è¡¨ä¸­ï¼Œå¦‚æœå­˜åœ¨åˆ™å†åˆ¤æ–­ hash å€¼æ˜¯å¦ç›¸åŒï¼Œç›¸åŒå°±ä¸æ›´æ–°ï¼Œä¸ç›¸åŒå…ˆå°†æœ¬åœ°çš„æ–‡ä»¶åˆ é™¤ï¼Œç„¶åå†å°†å…¶å°±æ·»åŠ åˆ°æ›´æ–°èµ„æºçš„åˆ—è¡¨ä¸­ã€‚</li>
<li>å›¾ç‰‡å’Œ banner èµ„æºæ›´æ–°æµç¨‹å›¾ï¼š</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/8/1682acf03c9fed1a?w=554&amp;h=903&amp;f=png&amp;s=26742" alt="èµ„æºæ›´æ–°æµç¨‹å›¾.png"></p>
<ul>
<li>ä¸­æ§ä¸­è®¡ç®—èµ„æºä½ çš„ hash å€¼</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">    // banner èµ„æºæ–‡ä»¶</span><br><span class="line">    String fileName = fileFilter.getAbsolutePath().substring(baseDirLength);</span><br><span class="line">    RandomAccessFile randomAccessFile = new RandomAccessFile(fileFilter,&quot;r&quot;);</span><br><span class="line">    byte[] buf = new byte[(int) randomAccessFile.length()];</span><br><span class="line">    randomAccessFile.read(buf);</span><br><span class="line">    randomAccessFile.close();</span><br><span class="line">    MessageDigest md5 = MessageDigest.getInstance(&quot;md5&quot;);</span><br><span class="line">    byte[] hash = md5.digest(buf);</span><br><span class="line">    String hashStr = ByteToHex(hash,0,hash.length);</span><br><span class="line">    res.bannerFiles.put(hashStr,fileName);</span><br><span class="line">&#125; catch (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; catch (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// å­—èŠ‚è½¬æ¢ä¸º 16 è¿›åˆ¶</span><br><span class="line">public static String ByteToHex(byte[] bt, int offset, int len) &#123;</span><br><span class="line">    StringBuffer sb = new StringBuffer();</span><br><span class="line">    for (int i = offset; i &lt; offset + len; i++) &#123;</span><br><span class="line">        int tmp = bt[i] &amp; 0xff;</span><br><span class="line">        String tmpStr = Integer.toHexString(tmp);</span><br><span class="line">        if (tmpStr.length() &lt; 2)</span><br><span class="line">            sb.append(&quot;0&quot;);</span><br><span class="line">        sb.append(tmpStr);</span><br><span class="line">    &#125;</span><br><span class="line">    return sb.toString().toUpperCase();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>å¨ƒå¨ƒæœºè®¾å¤‡æ£€æŸ¥æ›´æ–°ï¼ˆä¾‹å¦‚ï¼šbanner èµ„æºæ–‡ä»¶ï¼‰</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">public static Observable&lt;Boolean&gt; updateBannerRes(ResListBean resListBean) throws IOException, NoSuchAlgorithmException &#123;</span><br><span class="line">    // è·å–è¿œç¨‹ banner çš„æ–‡ä»¶</span><br><span class="line">    HashMap&lt;File, String&gt; remoteFiles = new HashMap();</span><br><span class="line">    for (HashMap.Entry&lt;String, String&gt; entry : resListBean.bannerFiles.entrySet()) &#123;</span><br><span class="line">        remoteFiles.put(new File(entry.getValue()), entry.getKey());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FileUtils.GetFilesInDir(bannerDir,localBannerList,null);</span><br><span class="line">    int baseDirLength = resDir.getAbsolutePath().length()+1;</span><br><span class="line">    // step1ï¼šåˆ é™¤æœ¬åœ°æ–‡ä»¶ï¼ˆè¿œç¨‹ banner ä¸­æ²¡æœ‰çš„æ–‡ä»¶ï¼‰</span><br><span class="line">    for (File localFile : localBannerList) &#123;</span><br><span class="line">        File chileFile = new File(localFile.getAbsolutePath().substring(baseDirLength));</span><br><span class="line">        if (!remoteFiles.containsKey(chileFile)) &#123;</span><br><span class="line">            MainActivity.appendAndScrollLog(String.format(&quot;åˆ é™¤ banner èµ„æºæ–‡ä»¶ %s\n&quot;, localFile.getAbsolutePath()));</span><br><span class="line">            localFile.delete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ä¸‹è½½æœ¬åœ°æ²¡æœ‰çš„æ–‡ä»¶</span><br><span class="line">    ArrayList&lt;Observable&lt;File&gt;&gt; taskList = new ArrayList();</span><br><span class="line">    for (Map.Entry&lt;File, String&gt; fileEntry : remoteFiles.entrySet()) &#123;</span><br><span class="line">        File file = new File(resDir,fileEntry.getKey().getAbsolutePath());</span><br><span class="line"></span><br><span class="line">        // step2ï¼šæœ¬åœ°ä¸­å­˜åœ¨å’Œè¿œç¨‹ç›¸åŒçš„æ–‡ä»¶å</span><br><span class="line">        if (localBannerList.contains(file)) &#123;</span><br><span class="line">            // step3ï¼šæ ¹æ® hash å€¼åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€æ–‡ä»¶</span><br><span class="line">            String hashStr = FileUtils.getFileHashStr(file);</span><br><span class="line">            if (TextUtils.equals(hashStr,fileEntry.getValue()))&#123;</span><br><span class="line">                MainActivity.appendAndScrollLog(String.format(&quot;ä¿ç•™ banner æ–‡ä»¶ %s\n&quot;, file.getAbsolutePath()));</span><br><span class="line">                taskList.add(Observable.just(file));</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // step4ï¼šä¸‹è½½æœ¬åœ°æ²¡æœ‰çš„æ–‡ä»¶</span><br><span class="line">        String url = new URL(&quot;http&quot;, Config.instance.centralServerAddress,</span><br><span class="line">                Config.instance.httpPort,</span><br><span class="line">                new File(BuildConfig.APPLICATION_ID, fileEntry.getKey().getAbsolutePath()).getAbsolutePath()).toString();</span><br><span class="line">        // step5ï¼šåŠ å…¥æ–‡ä»¶ä¸‹è½½åˆ—è¡¨</span><br><span class="line">        taskList.add(DownLoadUtils.getDownLoadFile(url,file));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return Observable.concat(taskList)</span><br><span class="line">            .toFlowable(BackpressureStrategy.MISSING)</span><br><span class="line">            .parallel()</span><br><span class="line">            .runOn(Schedulers.io())</span><br><span class="line">            .sequential()</span><br><span class="line">            .toList()</span><br><span class="line">            .observeOn(Schedulers.computation())</span><br><span class="line">            .map(new Function&lt;List&lt;File&gt;, ArrayList&lt;File&gt;&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public ArrayList&lt;File&gt; apply(List&lt;File&gt; files) throws Exception &#123;</span><br><span class="line">                    ArrayList&lt;File&gt; list = new ArrayList();</span><br><span class="line">                    for (File file : files) &#123;</span><br><span class="line">                        if (!file.getAbsolutePath().isEmpty()) &#123;</span><br><span class="line">                            list.add(file);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    if (list.size() &gt; 0) &#123;</span><br><span class="line">                        if (!Utils.EqualCollection(list, localBannerList)) &#123;</span><br><span class="line">                            Collections.sort(list);</span><br><span class="line">                        &#125; else &#123;</span><br><span class="line">                            list.clear();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    return list;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">            .map(new Function&lt;ArrayList&lt;File&gt;, Boolean&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Boolean apply(ArrayList&lt;File&gt; list) throws Exception &#123;</span><br><span class="line">                    if (list.size() &gt; 0) &#123;</span><br><span class="line">                        localBannerList = list;</span><br><span class="line">                        webViewHasLoad = false;</span><br><span class="line">                        loadH5();</span><br><span class="line">                    &#125;</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .observeOn(Schedulers.io())</span><br><span class="line">            .map(new Function&lt;Boolean, Boolean&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Boolean apply(Boolean aBoolean) throws Exception &#123;</span><br><span class="line">                    FileUtils.DelEmptyDir(resDir);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .toObservable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¨‹åºå‡çº§çš„é—®é¢˜"><a href="#ç¨‹åºå‡çº§çš„é—®é¢˜" class="headerlink" title="ç¨‹åºå‡çº§çš„é—®é¢˜"></a>ç¨‹åºå‡çº§çš„é—®é¢˜</h3><p>å…³äºç¨‹åºçš„å‡çº§ï¼Œç›¸æ¯”è¾ƒäºå›¾ç‰‡èµ„æºçš„æ›´æ–°è¦ç®€å•è®¸å¤šã€‚</p>
<ul>
<li>æˆ‘ä»¬çš„å®ç°ç‰ˆæœ¬æ›´æ–°çš„æ­¥éª¤å¦‚ä¸‹ï¼š<ul>
<li>step1ï¼šæ‰¾å‡ºæœ¬åœ°å­˜åœ¨çš„ apk æ–‡ä»¶ï¼ˆè®¾å¤‡çš„ä¸­çš„ apk éƒ½æ˜¯åˆ¶å®šè·¯å¾„å’Œåˆ¶å®šæ–‡ä»¶åçš„ï¼‰ï¼Œå°†å…¶åˆ é™¤ã€‚</li>
<li>step2ï¼šåˆ¤æ–­ä¸­æ§ä¸­çš„å®‰è£…åŒ…çš„ç‰ˆæœ¬å·æ˜¯å¦å¤§äºæœ¬åœ°ç¨‹åºçš„ç‰ˆæœ¬å·ï¼Œå¦‚æœæ˜¯åˆ™è¿›å…¥ step3ï¼›å¦åˆ™å¿½ç•¥ï¼Œä¸éœ€è¦ç¨‹åºå‡çº§</li>
<li>step3ï¼šä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„ apk å®‰è£…åŒ…</li>
<li>step4ï¼šä¸‹è½½æˆåŠŸåï¼Œå‘é€å¹¿æ’­ï¼ˆactionï¼šåŒ…åï¼›extraï¼šapkæ–‡ä»¶è·¯å¾„ï¼‰ç»™ rocket ç¨‹åº</li>
<li>step5ï¼šrocket ç¨‹åºæ¥æ”¶åˆ°å¹¿æ’­ä¹‹åå°±å‡çº§ç¨‹åº</li>
</ul>
</li>
<li>ç¨‹åºå‡çº§æµç¨‹å›¾</li>
</ul>
<p><img src="https://user-gold-cdn.xitu.io/2019/1/8/1682acff1d3b841b?w=554&amp;h=903&amp;f=png&amp;s=22121" alt="ç‰ˆæœ¬æ›´æ–°æµç¨‹.png"></p>
<ul>
<li>å…·ä½“ä»£ç å®ç°</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public static Observable&lt;Boolean&gt; updateGame(ResListBean res) throws IOException, InterruptedException &#123;</span><br><span class="line">    ArrayList&lt;File&gt; apkList = new ArrayList();</span><br><span class="line">    FileUtils.GetFilesInDir(resDir, apkList, new String[]&#123;</span><br><span class="line">            &quot;.apk&quot;,</span><br><span class="line">    &#125;);</span><br><span class="line">    // åˆ é™¤æœ¬åœ°å­˜åœ¨çš„ apk åŒ…</span><br><span class="line">    for (File file : apkList) &#123;</span><br><span class="line">        file.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    do &#123;</span><br><span class="line">        if (res.UpdateApk == null || res.UpdateApkVersion == null) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        // åˆ¤æ–­æ˜¯å¦éœ€è¦å‡çº§</span><br><span class="line">        if (BuildConfig.VERSION_CODE &gt;= res.UpdateApkVersionCode) &#123;</span><br><span class="line">            break;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        // apk çš„ URL</span><br><span class="line">        final String url = new URL(&quot;http&quot;, Config.instance.centralServerAddress, Config.instance.httpPort, new File(BuildConfig.APPLICATION_ID, res.UpdateApk).getAbsolutePath()).toString();</span><br><span class="line">        MainActivity.appendAndScrollLog(String.format(&quot;ä¸‹è½½å‡çº§æ–‡ä»¶ %s\n&quot;, url));</span><br><span class="line">        // ä¸‹è½½ apk æ–‡ä»¶</span><br><span class="line">        return DownLoadUtils.getDownLoadFile(url,resDir.getAbsolutePath(),res.UpdateApk)</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .observeOn(Schedulers.io())</span><br><span class="line">                .flatMap(new Function&lt;File, ObservableSource&lt;String&gt;&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public ObservableSource&lt;String&gt; apply(File file) throws Exception &#123;</span><br><span class="line">                        String path = file.getAbsolutePath();</span><br><span class="line">                        MainActivity.appendAndScrollLog(String.format(&quot;å‡çº§æ–‡ä»¶ä¸‹è½½å®Œæˆ %s %s\n&quot;, path, url));</span><br><span class="line">                        PackageManager pm = MainActivity.instance.getPackageManager();</span><br><span class="line">                        PackageInfo pi = pm.getPackageArchiveInfo(path, 0);</span><br><span class="line">                        if (pi == null) &#123;</span><br><span class="line">                            MainActivity.appendAndScrollLog(String.format(&quot;å‡çº§æ–‡ä»¶æ‰“å¼€å¤±è´¥ %s\n&quot;, path));</span><br><span class="line">                            return Observable.just(&quot;&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        MainActivity.appendAndScrollLog(String.format(&quot;å‡çº§æ–‡ä»¶å¯¹æ¯”ï¼šNative(%s %s)/Remote(%s %s)\n&quot;, BuildConfig.APPLICATION_ID, BuildConfig.VERSION_NAME, pi.packageName, pi.versionName));</span><br><span class="line">                        if (!BuildConfig.APPLICATION_ID.equals(pi.packageName)</span><br><span class="line">                                || BuildConfig.VERSION_CODE &gt;= pi.versionCode) &#123;</span><br><span class="line">                            return Observable.just(&quot;&quot;);</span><br><span class="line">                        &#125;</span><br><span class="line">                        return Observable.just(path);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                .flatMap(new Function&lt;String, Observable&lt;Boolean&gt;&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public Observable&lt;Boolean&gt; apply(String updateApk) throws Exception &#123;</span><br><span class="line">                        if (!updateApk.isEmpty()) &#123;</span><br><span class="line">                            Log.e(TAG, &quot;ç­‰å¾…æ¸¸æˆç»“æŸåå®‰è£…å‡çº§æ–‡ä»¶...&quot;);</span><br><span class="line">                            MainActivity.appendAndScrollLog(&quot;ç­‰å¾…æ¸¸æˆç»“æŸåå®‰è£…å‡çº§æ–‡ä»¶...\n&quot;);</span><br><span class="line">                            synchronized (GamePlay.class) &#123;//é˜²æ­¢åœ¨æ¸¸æˆè¿è¡Œæ—¶æ›´æ–°ç‰ˆæœ¬</span><br><span class="line">                                Log.e(TAG, &quot;å‘å¸ƒå¹¿æ’­&quot;);</span><br><span class="line">                                Intent intent = new Intent();</span><br><span class="line">                                intent.setAction(Config.updateBroadcast);</span><br><span class="line">                                intent.putExtra(&quot;apk&quot;, updateApk);</span><br><span class="line">                                MainActivity.instance.sendBroadcast(intent);</span><br><span class="line">                                System.exit(0);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        return Observable.just(true);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125; while (false);</span><br><span class="line">    return Observable.just(true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="èµ„æºæ–‡ä»¶ä¸‹è½½"><a href="#èµ„æºæ–‡ä»¶ä¸‹è½½" class="headerlink" title="èµ„æºæ–‡ä»¶ä¸‹è½½"></a>èµ„æºæ–‡ä»¶ä¸‹è½½</h3><p>å…³äºèµ„æºæ–‡ä»¶çš„ä¸‹è½½ï¼Œæˆ‘æ˜¯é€‰æ‹© <a href="https://github.com/lingochamp/okdownload" target="_blank" rel="noopener">okdownload</a>ã€‚okdownload æ˜¯ä¸€ä¸ªæ”¯æŒå¤šçº¿ç¨‹ï¼Œå¤šä»»åŠ¡ï¼Œæ–­ç‚¹ç»­ä¼ ï¼Œå¯é ï¼Œçµæ´»ï¼Œé«˜æ€§èƒ½ä»¥åŠå¼ºå¤§çš„ä¸‹è½½å¼•æ“ã€‚è¯¦æƒ…å¯ä»¥å»çœ‹ <a href="https://github.com/lingochamp/okdownload" target="_blank" rel="noopener">okdownload GitHub åœ°å€</a></p>
<ul>
<li><p>ä¾èµ–æ–¹å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;com.liulishuo.okdownload:okdownload:1.0.5&apos;</span><br><span class="line">implementation &apos;com.liulishuo.okdownload:okhttp:1.0.5&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç®€å•å®ç”¨ç¤ºä¾‹</p>
</li>
</ul>
<p><strong>å•æ–‡ä»¶ä¸‹è½½</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DownloadTask task = new DownloadTask.Builder(url, parentFile)</span><br><span class="line">         .setFilename(filename)</span><br><span class="line">         // the minimal interval millisecond for callback progress</span><br><span class="line">         .setMinIntervalMillisCallbackProcess(30)</span><br><span class="line">         // do re-download even if the task has already been completed in the past.</span><br><span class="line">         .setPassIfAlreadyCompleted(false)</span><br><span class="line">         .build();</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">task.enqueue(listener);</span><br><span class="line"> </span><br><span class="line">// cancel</span><br><span class="line">task.cancel();</span><br><span class="line"> </span><br><span class="line">// execute task synchronized</span><br><span class="line">task.execute(listener);</span><br></pre></td></tr></table></figure></p>
<p><strong>å¤šæ–‡ä»¶ä¸‹è½½</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">final DownloadTask[] tasks = new DownloadTask[2];</span><br><span class="line">tasks[0] = new DownloadTask.Builder(&quot;url1&quot;, &quot;path&quot;, &quot;filename1&quot;).build();</span><br><span class="line">tasks[1] = new DownloadTask.Builder(&quot;url2&quot;, &quot;path&quot;, &quot;filename1&quot;).build();</span><br><span class="line">DownloadTask.enqueue(tasks, listener);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>ç»“åˆ Rxjava å®ç°æ–‡ä»¶ä¸‹è½½<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class DownLoadUtils &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ä»ä¸­æ§ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°</span><br><span class="line">     * @param url</span><br><span class="line">     * @param parentPath            ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶çš„çˆ¶æ–‡ä»¶è·¯å¾„</span><br><span class="line">     * @param downloadFileName      ä¿å­˜åˆ°æœ¬åœ°çš„æ–‡ä»¶å</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static Observable&lt;File&gt; getDownLoadFile(String url,String parentPath,String downloadFileName)&#123;</span><br><span class="line">        // ä¸‹è½½æœ¬åœ°æ²¡æœ‰çš„æ–‡ä»¶</span><br><span class="line">        MainActivity.appendAndScrollLog(String.format(&quot;å¼€å§‹ä¸‹è½½èµ„æºæ–‡ä»¶ %s\n&quot;, url));</span><br><span class="line">        final DownloadTask task = new DownloadTask.Builder(url, parentPath, downloadFileName).build();</span><br><span class="line">        return Observable.create(new ObservableOnSubscribe&lt;File&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void subscribe(final ObservableEmitter&lt;File&gt; emitter) throws Exception &#123;</span><br><span class="line">                task.enqueue(new DownloadListener2() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void taskStart(DownloadTask task) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    @Override</span><br><span class="line">                    public void taskEnd(DownloadTask task, EndCause cause, Exception realCause) &#123;</span><br><span class="line">                        if (cause != EndCause.COMPLETED) &#123;</span><br><span class="line">                            MainActivity.appendAndScrollLog(String.format(&quot;èµ„æºæ–‡ä»¶ä¸‹è½½å¤±è´¥ %s %s\n&quot;, cause.toString(), task.getUrl()));</span><br><span class="line">                            emitter.onNext(new File(&quot;&quot;));</span><br><span class="line">                            emitter.onComplete();</span><br><span class="line">                            return;</span><br><span class="line">                        &#125;</span><br><span class="line">                        File file = task.getFile();</span><br><span class="line">                        MainActivity.appendAndScrollLog(String.format(&quot;èµ„æºæ–‡ä»¶ä¸‹è½½å®Œæˆ %s\n&quot;, file.getAbsolutePath()));</span><br><span class="line">                        emitter.onNext(file);</span><br><span class="line">                        emitter.onComplete();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).retry();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * ä»ä¸­æ§ä¸‹è½½æ–‡ä»¶åˆ°æœ¬åœ°</span><br><span class="line">     * @param url</span><br><span class="line">     * @param saveFile  ä¿å­˜åˆ°æœ¬åœ°çš„æ–‡ä»¶</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public static Observable&lt;File&gt; getDownLoadFile(String url, File saveFile)&#123;</span><br><span class="line">        return getDownLoadFile(url,saveFile.getParentFile().getAbsolutePath(),saveFile.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="å±è”½ä¸‹æ‹‰èœå•å’Œåº•éƒ¨å¯¼èˆªæ "><a href="#å±è”½ä¸‹æ‹‰èœå•å’Œåº•éƒ¨å¯¼èˆªæ " class="headerlink" title="å±è”½ä¸‹æ‹‰èœå•å’Œåº•éƒ¨å¯¼èˆªæ "></a>å±è”½ä¸‹æ‹‰èœå•å’Œåº•éƒ¨å¯¼èˆªæ </h2><p>åƒå¨ƒå¨ƒæœºå’Œæ ¼å­æœºè¿™äº›è®¾å¤‡éƒ½æ˜¯åœ¨çº¿ä¸‹ç›´æ¥é¢å‘ç”¨æˆ·çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½å°†æˆ‘ä»¬çš„ Android è®¾å¤‡å…¨éƒ¨éƒ½å±•ç°ç»™æˆ‘ä»¬çš„ç”¨æˆ·ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ç”¨æˆ·çš„è¡Œä¸ºåšäº›é™åˆ¶ï¼Œä¾‹å¦‚ç¦æ­¢ç”¨æˆ·é€šè¿‡å¯¼èˆªæ æˆ–è€…ä¸‹æ‹‰èœå•é€€å‡ºå½“å‰ç¨‹åºï¼Œé˜²æ­¢ä»–ä»¬åšå‡ºä¸€äº›å±é™©çš„æ“ä½œã€‚æˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯æŠŠå½“å‰çš„ rocket ç¨‹åºè®¾ç½®ä¸ºé»˜è®¤å¯åŠ¨å’Œæ¡Œé¢åº”ç”¨ç¨‹åºï¼Œå¹¶å°† Android è®¾å¤‡ä¸­è‡ªå¸¦çš„ launcher ç¨‹åº å’Œ systemui ç¨‹åºç»™ç¦ç”¨æ‰ï¼Œé‚£ä¹ˆè®¾å¤‡ä¸€å¼€å§‹å¯åŠ¨çš„æ—¶å€™å°±ä¼šå¯åŠ¨æˆ‘ä»¬çš„ rocket åº”ç”¨ï¼Œå¹¶æˆåŠŸçš„ç¦æ­¢äº†ç”¨æˆ·ä½¿ç”¨å¯¼èˆªæ å’Œä¸‹æ‹‰èœå•æ¥åšéæ³•çš„æ“ä½œã€‚</p>
<ul>
<li><p>æŸ¥æ‰¾ Android è®¾å¤‡ä¸­è‡ªå¸¦çš„ launcher ç¨‹åº å’Œ systemui ç¨‹åºçš„å¯¹åº”åŒ…å</p>
<ul>
<li>æˆ‘ä»¬ä½¿ç”¨ adb shell pm list packages å°±å¯ä»¥æ‰¾å‡ºè®¾å¤‡ä¸­å·²ç»å®‰è£…çš„ç¨‹åºåˆ—è¡¨ï¼Œä¸»è¦æ˜¯ä»¥åŒ…åæ˜¾ç¤ºçš„ã€‚</li>
<li><p><strong>æŸ¥æ‰¾ launcher ç¨‹åºçš„åŒ…å</strong>ï¼Œæ‰¾å‡ºåŒ…åä¸ºï¼šcom.android.launcher3</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LW-PC0920@lw1002022 MINGW64 ~/Desktop</span><br><span class="line">$ adb shell pm list packages | grep launcher</span><br><span class="line">package:com.android.launcher3</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æŸ¥æ‰¾ systemui ç¨‹åºçš„åŒ…å</strong>ï¼šæ‰¾å‡ºåŒ…åä¸ºï¼šcom.android.systemui</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LW-PC0920@lw1002022 MINGW64 ~/Desktop</span><br><span class="line">$ adb shell pm list packages | grep systemui</span><br><span class="line">package:com.android.systemui</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>ç¦æ­¢ Android è®¾å¤‡ä¸­è‡ªå¸¦çš„ launcher ç¨‹åº å’Œ systemui ç¨‹åºçš„ä½¿ç”¨</p>
<ul>
<li><p>ç¦æ­¢ launcher ç¨‹åºçš„ä½¿ç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm disable com.android.launcher3</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¦æ­¢ systemui ç¨‹åºçš„ä½¿ç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb shell pm disable com.android.systemui</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>ä»£ç å®ç°ç¦æ­¢ Android è®¾å¤‡ä¸­è‡ªå¸¦çš„ launcher ç¨‹åº å’Œ systemui ç¨‹åºçš„ä½¿ç”¨</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">public static void enableLauncher(Boolean enabled) &#123;</span><br><span class="line">    List&lt;PackageInfo&gt; piList = MainActivity.instance.packageManager.getInstalledPackages(0);</span><br><span class="line">    ArrayList&lt;String&gt; packages = new ArrayList();</span><br><span class="line">    for (PackageInfo pi : piList) &#123;</span><br><span class="line">        String name = pi.packageName;</span><br><span class="line">        if (name.contains(&quot;systemui&quot;) || name.contains(&quot;launcher&quot;)) &#123;</span><br><span class="line">            packages.add(name);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    for (String packageName : packages) &#123;</span><br><span class="line">        su(String.format(&quot;pm %s %s\n&quot;, enabled ? &quot;enable&quot; : &quot;disable&quot;, packageName));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> *  æ‰§è¡Œ adb æŒ‡ä»¤</span><br><span class="line"> *</span><br><span class="line"> */</span><br><span class="line">public static int su(String cmd) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        Process p = Runtime.getRuntime().exec(&quot;su&quot;);</span><br><span class="line">        DataOutputStream os = new DataOutputStream(p.getOutputStream());</span><br><span class="line">        os.writeBytes(cmd);</span><br><span class="line">        os.writeBytes(&quot;exit\n&quot;);</span><br><span class="line">        os.flush();</span><br><span class="line">        os.close();</span><br><span class="line">        return p.waitFor();</span><br><span class="line">    &#125; catch (Exception ex) &#123;</span><br><span class="line">        return -1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Iot-çš„å®ç°"><a href="#Iot-çš„å®ç°" class="headerlink" title="Iot çš„å®ç°"></a>Iot çš„å®ç°</h2><p>å…³äº IoT çš„å®ç°ï¼Œæˆ‘ä»¬è¿™è¾¹ä½¿ç”¨çš„æ˜¯é˜¿é‡Œçš„ã€Šå¾®æ¶ˆæ¯é˜Ÿåˆ— for IoTã€‹æœåŠ¡ï¼Œå…³äºã€Šå¾®æ¶ˆæ¯é˜Ÿåˆ— for IoTã€‹æœåŠ¡ï¼Œé˜¿é‡Œçš„è§£é‡Šå¦‚ä¸‹ï¼š</p>
<blockquote>
<p>å¾®æ¶ˆæ¯é˜Ÿåˆ— for IoT æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰çš„å­äº§å“ã€‚é’ˆå¯¹ç”¨æˆ·åœ¨ç§»åŠ¨äº’è”ç½‘ä»¥åŠç‰©è”ç½‘é¢†åŸŸçš„å­˜åœ¨çš„ç‰¹æ®Šæ¶ˆæ¯ä¼ è¾“éœ€æ±‚ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMQï¼‰ é€šè¿‡æ¨å‡ºå¾®æ¶ˆæ¯é˜Ÿåˆ— for IoT å¼€æ”¾äº†å¯¹ MQTT åè®®çš„å®Œæ•´æ”¯æŒ</p>
</blockquote>
<ul>
<li>MQTT åè®®ï¼Ÿ<ul>
<li>MQTT çš„å…¨ç§°æ˜¯ï¼šMessage Queuing Telemetry Transportï¼ˆ æ¶ˆæ¯é˜Ÿåˆ—é¥æµ‹ä¼ è¾“ï¼‰ï¼Œæ˜¯ä¸€ç§è½»é‡çš„ï¼ŒåŸºäºå‘å¸ƒè®¢é˜…æ¨¡å‹çš„å³æ—¶é€šè®¯åè®®ã€‚è¯¥åè®®è®¾è®¡å¼€æ”¾ï¼Œåè®®ç®€å•ï¼Œå¹³å°æ”¯æŒä¸°å¯Œï¼Œå‡ ä¹å¯ä»¥æŠŠæ‰€æœ‰è”ç½‘ç‰©å“å’Œå¤–éƒ¨è¿æ¥èµ·æ¥ï¼Œå› æ­¤åœ¨ç§»åŠ¨äº’è”ç½‘å’Œç‰©è”ç½‘é¢†åŸŸæ‹¥æœ‰ä¼—å¤šä¼˜åŠ¿ã€‚</li>
</ul>
</li>
<li>MQTT çš„ç‰¹ç‚¹<ul>
<li>ä½¿ç”¨å‘å¸ƒ/è®¢é˜…ï¼ˆPub/Subï¼‰æ¶ˆæ¯æ¨¡å¼ï¼Œæä¾›ä¸€å¯¹å¤šçš„æ¶ˆæ¯åˆ†å‘ï¼Œè§£é™¤äº†åº”ç”¨ç¨‹åºä¹‹é—´çš„è€¦åˆï¼›</li>
<li>å¯¹è´Ÿè½½å†…å®¹å±è”½çš„æ¶ˆæ¯ä¼ è¾“ï¼›</li>
<li>ä½¿ç”¨ TCP/IP æä¾›åŸºç¡€çš„ç½‘ç»œè¿æ¥ï¼›</li>
<li>æœ‰ä¸‰ç§çº§åˆ«çš„æ¶ˆæ¯ä¼ é€’æœåŠ¡ï¼›</li>
<li>å°å‹ä¼ è¾“ï¼Œå¼€é”€å¾ˆå°ï¼ˆå¤´éƒ¨é•¿åº¦å›ºå®šä¸º 2 å­—èŠ‚ï¼‰ï¼Œåè®®äº¤æ¢æœ€å°åŒ–ï¼Œä»¥é™ä½ç½‘ç»œæµé‡ã€‚</li>
</ul>
</li>
<li>å…³é”®åè¯çš„è§£é‡Š<br>  åè¯|è§£é‡Š<br>  â€“|â€“<br>  Parent Topic|MQTT åè®®åŸºäº Pub/Sub æ¨¡å‹ï¼Œå› æ­¤ä»»ä½•æ¶ˆæ¯éƒ½å±äºä¸€ä¸ª Topicã€‚æ ¹æ® MQTT åè®®ï¼ŒTopic å­˜åœ¨å¤šçº§ï¼Œå®šä¹‰ç¬¬ä¸€çº§ Topic ä¸ºçˆ¶ Topicï¼ˆParent Topicï¼‰ï¼Œä½¿ç”¨ MQTT å‰ï¼Œè¯¥ Parent Topic éœ€è¦å…ˆåœ¨ MQ æ§åˆ¶å°åˆ›å»ºã€‚<br>  Subtopic|MQTT çš„äºŒçº§ Topicï¼Œç”šè‡³ä¸‰çº§ Topic éƒ½æ˜¯çˆ¶ Topic ä¸‹çš„å­ç±»ã€‚ä½¿ç”¨æ—¶ï¼Œç›´æ¥åœ¨ä»£ç é‡Œè®¾ç½®ï¼Œæ— éœ€åˆ›å»ºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ MQTT é™åˆ¶ Parent Topic å’Œ Subtopic çš„æ€»é•¿åº¦ä¸º64ä¸ªå­—ç¬¦ï¼Œå¦‚æœè¶…å‡ºé•¿åº¦é™åˆ¶å°†ä¼šå¯¼è‡´å®¢æˆ·ç«¯å¼‚å¸¸ã€‚<br>  Client ID|MQTT çš„ Client ID æ˜¯æ¯ä¸ªå®¢æˆ·ç«¯çš„å”¯ä¸€æ ‡è¯†ï¼Œè¦æ±‚å…¨å±€å”¯ä¸€ï¼Œä½¿ç”¨ç›¸åŒçš„ Client ID è¿æ¥ MQTT æœåŠ¡ä¼šè¢«æ‹’ç»<h3 id="Android-ä¸­å®ç°-iot"><a href="#Android-ä¸­å®ç°-iot" class="headerlink" title="Android ä¸­å®ç° iot"></a>Android ä¸­å®ç° iot</h3><blockquote>
<p>å…³äºæ˜¾ç¤º iot è¿æ¥çš„å®ç°è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šé¦–å…ˆæˆ‘ä»¬å°†è®¾å¤‡çš„ä¸‰å…ƒç»„ä»ç®¡ç†åå°ä¸­æ‰¹é‡ç”Ÿæˆï¼Œæ–‡ä»¶åçš„æ ¼å¼ä¸º <strong>deviceName.json</strong>(ä¾‹å¦‚ï¼š00001.json)ï¼Œé‡Œé¢æ˜¯å…³äºæ¯ä¸ªè®¾å¤‡çš„ä¸‰å…ƒç»„ä¿¡æ¯ï¼›æ¥ç€æˆ‘ä»¬å°†è£…æœ‰ä¸‰å…ƒç»„æ–‡ä»¶çš„ U ç›˜æ’å…¥åˆ° Android è®¾å¤‡ä¸­ï¼ˆå¨ƒå¨ƒæœºæˆ–è€…å£çº¢æŒ‘æˆ˜ï¼‰ï¼›rocket ç¨‹åºä¼šè‡ªåŠ¨ç›‘æµ‹åˆ° U ç›˜çš„æ’å…¥å¹¶å°†æ–‡ä»¶å‰ªåˆ‡åˆ° Android  è®¾å¤‡çš„åˆ¶å®šç›®å½•ä¸‹ï¼›å†æ¥ç€ Android è®¾å¤‡å¯ä»¥å»è¯»å–æŒ‡å®šæ–‡ä»¶ä¸­ä¸‰å…ƒç»„ä¿¡æ¯ï¼›æœ€åä½¿ç”¨æ­¤ä¸‰å…ƒç»„è¿›è¡Œè¿æ¥ mqttã€‚</p>
</blockquote>
</li>
<li>æ·»åŠ ä¾èµ–</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;org.eclipse.paho:org.eclipse.paho.client.mqttv3:1.2.0&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>å…³äºä¸‰å…ƒç»„</p>
<ul>
<li><p>åœ¨ Android è®¾å¤‡ä¸­éœ€è¦å…³å¿ƒçš„ä¸‰ä¸ªä¸œè¥¿ï¼Œmqtt åè®®ä¸­ç”¨æ¥è¯†åˆ«ä¸€ä¸ªè®¾å¤‡çš„å¿…è¦ä¸‰è¦ç´ ï¼Œå¦‚æœå­˜åœ¨ç›¸åŒçš„ä¸‰å…ƒç»„ï¼Œé‚£ä¹ˆå¿…ç„¶å‡ºé”™ï¼Œå¯¼è‡´mqtt é¢‘ç¹æ–­å¼€é‡è¿ã€‚ä¸‰å…ƒç»„è¿™ä¸ªä¸»è¦æ˜¯åœ¨é˜¿é‡Œçš„ç®¡ç†åå°ç”Ÿæˆçš„ï¼ŒAndroid è®¾å¤‡è¿™ç«¯åªéœ€è¦æ‹¿æ¥ç”¨å°±å¯ä»¥äº†ã€‚</p>
<p>å±æ€§|ç”¨å¤„<br>â€“|â€“<br>productKey|å¯¹åº”ç¨‹åºçš„ keyï¼Œç±»ä¼¼äº appid<br>deviceName|å¯¹åº”ä¸Šè¿°çš„ Client IDï¼Œç”¨æ¥å”¯ä¸€è¯†åˆ«ä¸€å° Android è®¾å¤‡çš„<br>deviceSecret|ä½¿ç”¨ HmacSHA1 ç®—æ³•è®¡ç®—ç­¾åå­—ç¬¦ä¸²ï¼Œå¹¶å°†ç­¾åå­—ç¬¦ä¸²è®¾ç½®åˆ° Password å‚æ•°ä¸­ç”¨äºé‰´æƒ</p>
</li>
</ul>
</li>
<li><p>å…³äºè®¢é˜…çš„ topic</p>
<ul>
<li>å…³äº topic æ˜¯åœ¨é˜¿é‡Œäº‘çš„åå°ç®¡ç†ä¸­è¿›è¡Œè®¾ç½®çš„ï¼Œæˆ‘ä»¬çš„æ”¶å‘æ¶ˆæ¯éƒ½æ˜¯é€šè¿‡è¿™äº› topic æ¥è¿›è¡Œçš„ã€‚ </li>
</ul>
</li>
<li><p>ä»£ç å®ç° iot è¿æ¥</p>
<ul>
<li><p><strong>å‰ªåˆ‡ä¸‰å…ƒç»„é…ç½®æ–‡ä»¶</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * å‰ªåˆ‡é…ç½®æ–‡ä»¶ï¼ˆä¸‰å…ƒç»„ï¼‰</span><br><span class="line"> * @param packageName</span><br><span class="line"> */</span><br><span class="line">public static void moveConfig(String packageName) &#123;</span><br><span class="line">    File usbConfigDir = new File(UsbStorage.usbPath, Config.wejoyConfigDirInUsb);</span><br><span class="line">    File extProjectDir = new File(Environment.getExternalStorageDirectory(), Config.resourceDirName);</span><br><span class="line">    File extConfigFile = new File(extProjectDir, Config.wejoyConfigFileInSdcard);</span><br><span class="line">    if (!usbConfigDir.exists() || extConfigFile.exists()) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    extProjectDir.mkdirs();</span><br><span class="line">    File[] configFiles = usbConfigDir.listFiles();</span><br><span class="line">    if (configFiles.length &gt; 0) &#123;</span><br><span class="line">        Arrays.sort(configFiles);</span><br><span class="line">        moveFile(configFiles[0], extConfigFile);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public static void moveFile(File src, File dst) &#123;</span><br><span class="line">    su(String.format(&quot;mv -f %s %s\n&quot;, src.getAbsolutePath(), dst.getAbsolutePath()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¯»å–æŒ‡å®šè·¯å¾„çš„é…ç½®æ–‡ä»¶ä¿¡æ¯(ä¸‰å…ƒç»„ï¼‰</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public static File configFile = new File(new File(Environment.getExternalStorageDirectory(), &quot;WejoyRes&quot;), &quot;Config.json&quot;);</span><br><span class="line"></span><br><span class="line">static void read() throws IOException &#123;</span><br><span class="line">    if (configFile.exists()) &#123;</span><br><span class="line">        RandomAccessFile in = new RandomAccessFile(configFile, &quot;r&quot;);</span><br><span class="line">        byte[] buf = new byte[(int) configFile.length()];</span><br><span class="line">        in.read(buf);</span><br><span class="line">        in.close();</span><br><span class="line">        instance = JsonIterator.deserialize(new String(buf, &quot;utf-8&quot;), Config.class);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        instance = new Config();</span><br><span class="line">    &#125;</span><br><span class="line">    mqttRequestTopic = String.format(&quot;/sys/%s/%s/rrpc/request/&quot;, instance.productKey, instance.deviceName);</span><br><span class="line">    mqttResponseTopic = String.format(&quot;/sys/%s/%s/rrpc/response/&quot;, instance.productKey, instance.deviceName);</span><br><span class="line">    mqttPublishTopic = String.format(&quot;/%s/%s/update&quot;, instance.productKey, instance.deviceName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>è¿æ¥ mqtt</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">static void init() &#123;</span><br><span class="line">    instance = new IoT();</span><br><span class="line">    DeviceInfo deviceInfo = new DeviceInfo();</span><br><span class="line">    deviceInfo.productKey = Config.instance.productKey;</span><br><span class="line">    deviceInfo.deviceName = Config.instance.deviceName;</span><br><span class="line">    deviceInfo.deviceSecret = Config.instance.deviceSecret;</span><br><span class="line">    final LinkKitInitParams params = new LinkKitInitParams();</span><br><span class="line">    params.deviceInfo = deviceInfo;</span><br><span class="line">    params.connectConfig = new IoTApiClientConfig();</span><br><span class="line">    LinkKit.getInstance().registerOnPushListener(instance);</span><br><span class="line">    initDisposable = Observable.interval(0, Config.instance.mqttConnectIntervalSeconds, TimeUnit.SECONDS)</span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            .observeOn(Schedulers.io())</span><br><span class="line">            .map(new Function&lt;Long, Boolean&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Boolean apply(Long aLong) throws Exception &#123;</span><br><span class="line">                    if (!initialized) &#123;</span><br><span class="line">                        LinkKit.getInstance().init(MainActivity.instance, params, instance);</span><br><span class="line">                    &#125;</span><br><span class="line">                    return initialized;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .subscribe(new Consumer&lt;Boolean&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void accept(Boolean aBoolean) throws Exception &#123;</span><br><span class="line">                    if (aBoolean) &#123;</span><br><span class="line">                        initDisposable.dispose();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>å‘é€æ¶ˆæ¯ï¼š</strong><br>å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æŒ‡å®š topicï¼Œå¦åˆ™æœåŠ¡å™¨æ— æ³•æ¥æ”¶åˆ°æˆ‘ä»¬çš„æ¶ˆæ¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    static void publish(String json) &#123;</span><br><span class="line">    Log.e(TAG, &quot;publish: &quot;+json );</span><br><span class="line">    MqttPublishRequest res = new MqttPublishRequest();</span><br><span class="line">    res.isRPC = false;</span><br><span class="line">    res.topic = Config.mqttPublishTopic;</span><br><span class="line">    res.payloadObj = json;</span><br><span class="line">    LinkKit.getInstance().publish(res, new IConnectSendListener() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onResponse(ARequest aRequest, AResponse aResponse) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void onFailure(ARequest aRequest, AError aError) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>æ¥æ”¶æ¶ˆæ¯ï¼š</strong> æ¥æ”¶æ¶ˆæ¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦åˆ¤æ–­æ˜¯æ¥è‡ªå“ªä¸ª topic ä¸­çš„ï¼Œé™¤äº†æˆ‘ä»¬æŒ‡å®šçš„ topicï¼Œå…¶ä»–çš„ topic æˆ‘ä»¬éƒ½ä¸åšå¤„ç†ï¼›å½“æˆ‘ä»¬æ¥æ”¶åˆ°æœåŠ¡å™¨ä¸­å‘é€æ¥çš„æ¶ˆæ¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯å…ˆåˆ¤æ–­æ¶ˆæ¯çš„ç±»å‹ï¼Œç„¶åæ ¹æ®ç›¸å¯¹åº”çš„ç±»å‹åšå‡ºä¸åŒçš„ååº”ã€‚ä¾‹å¦‚æˆ‘ä»¬æ”¶åˆ°åå°è¯·æ±‚ç»™å¨ƒå¨ƒæœºçš„ä¸Šåˆ†çš„æŒ‡ä»¤ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å‘è®¾å¤‡ä¸­çš„ç¡¬ä»¶æ¨¡å—å‘é€ä¸Šåˆ†çš„æŒ‡ä»¤ï¼Œå¹¶ç­‰å¾…è®¾å¤‡ååº”å¹¶ç»™åå°å‘é€ä¸€æ¡å“åº”ä¿¡æ¯ã€‚è¿™æ¡å“åº”çš„æ¶ˆæ¯æ˜¯éœ€è¦åœ¨æŒ‡å®šçš„æ—¶é—´å†…å®Œæˆï¼Œå¦åˆ™è®¤ä¸ºè¶…æ—¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void onNotify(String s, final String topic, final AMessage aMessage) &#123;</span><br><span class="line">    if (!topic.startsWith(Config.mqttRequestTopic)) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    Observable.create(new ObservableOnSubscribe&lt;MqttMessage&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void subscribe(ObservableEmitter&lt;MqttMessage&gt; emitter) throws Exception &#123;</span><br><span class="line">            MqttMessage msg = JsonIterator.deserialize(new String((byte[]) aMessage.data, &quot;utf-8&quot;), MqttMessage.class);</span><br><span class="line">            if (msg == null) &#123;</span><br><span class="line">                return;</span><br><span class="line">            &#125;</span><br><span class="line">            emitter.onNext(msg);</span><br><span class="line">            emitter.onComplete();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">            .subscribeOn(Schedulers.io())</span><br><span class="line">            .observeOn(Schedulers.io())</span><br><span class="line">            .flatMap(new Function&lt;MqttMessage, ObservableSource&lt;MqttMessage&gt;&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public ObservableSource&lt;MqttMessage&gt; apply(MqttMessage msg) throws Exception &#123;</span><br><span class="line">                    Log.e(TAG, &quot;æ”¶åˆ°æ¶ˆæ¯  key:&quot;+msg.key+&quot; msg:&quot;+msg.body.m);</span><br><span class="line">                    switch (msg.key) &#123;</span><br><span class="line">                        case &quot;h&quot;: &#123;//</span><br><span class="line">                            SetHeartBeatDownstream setHeartBeatDownstream = msg.body.m.as(SetHeartBeatDownstream.class);</span><br><span class="line">                            // å’Œè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œå¹¶ç­‰å¾…è®¾å¤‡çš„å“åº”</span><br><span class="line">                            return Device.setHeartBeat(setHeartBeatDownstream);</span><br><span class="line">                        &#125;</span><br><span class="line">                        case &quot;b&quot;: &#123;//</span><br><span class="line">                            AddCoinsDownstream addCoinsDownstream = msg.body.m.as(AddCoinsDownstream.class);</span><br><span class="line">                            // å’Œè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œå¹¶ç­‰å¾…è®¾å¤‡çš„å“åº”</span><br><span class="line">                            return Device.addCoins(addCoinsDownstream);</span><br><span class="line">                        &#125;</span><br><span class="line">                        case &quot;g&quot;: &#123;//</span><br><span class="line">                            // å’Œè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œå¹¶ç­‰å¾…è®¾å¤‡çš„å“åº”</span><br><span class="line">                            return Device.getParam();</span><br><span class="line">                        &#125;</span><br><span class="line">                        case &quot;s&quot;: &#123;//</span><br><span class="line">                            SetParamDownstream setParamDownstream = msg.body.m.as(SetParamDownstream.class);</span><br><span class="line">                            // å’Œè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œå¹¶ç­‰å¾…è®¾å¤‡çš„å“åº”</span><br><span class="line">                            return Device.setParam(setParamDownstream);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    return Observable.never();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .observeOn(Schedulers.io())</span><br><span class="line">            .map(new Function&lt;MqttMessage, Boolean&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Boolean apply(MqttMessage msg) throws Exception &#123;</span><br><span class="line">                    MqttPublishRequest res = new MqttPublishRequest();</span><br><span class="line">                    res.isRPC = false;</span><br><span class="line">                    res.topic = topic.replace(&quot;request&quot;, &quot;response&quot;);</span><br><span class="line">                    //res.msgId = topic.split(&quot;/&quot;)[6];</span><br><span class="line">                    res.payloadObj = JsonStream.serialize(msg);</span><br><span class="line">                    LinkKit.getInstance().publish(res, new IConnectSendListener() &#123;</span><br><span class="line">                        @Override</span><br><span class="line">                        public void onResponse(ARequest aRequest, AResponse aResponse) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        @Override</span><br><span class="line">                        public void onFailure(ARequest aRequest, AError aError) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    return true;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .subscribe();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="Android-å’Œç¡¬ä»¶é€šä¿¡"><a href="#Android-å’Œç¡¬ä»¶é€šä¿¡" class="headerlink" title="Android å’Œç¡¬ä»¶é€šä¿¡"></a>Android å’Œç¡¬ä»¶é€šä¿¡</h2><p>åœ¨å¨ƒå¨ƒæœºå’Œå£çº¢æŒ‘æˆ˜çš„è¿™ä¸¤ä¸ªè®¾å¤‡ä¸­ï¼Œæˆ‘ä»¬éƒ½éœ€è¦å’Œè®¾å¤‡è¿›è¡Œé€šä¿¡ï¼Œä¾‹å¦‚ï¼šå¨ƒå¨ƒæœºæŠ•å¸ã€å¨ƒå¨ƒæœºå‡ºç¤¼åé¦ˆã€æŒ‰ä¸‹é€‰ä¸­å£çº¢çš„æ ¼å­ç­‰ç­‰è¿™äº›éƒ½æ˜¯éœ€è¦å’Œç¡¬ä»¶æ¨¡å—è¿›è¡Œé€šä¿¡çš„ã€‚åœ¨å…³äºä¸²å£é€šä¿¡çš„æ¡†æ¶é€‰æ‹©æ–¹é¢ï¼Œæˆ‘ä»¬ä¸»è¦æ˜¯é€‰æ‹© Google çš„ android-serialport-api æ¥å®ç°ã€‚<a href="https://github.com/licheedev/Android-SerialPort-API" target="_blank" rel="noopener">é¡¹ç›®åŸåœ°å€</a></p>
<ul>
<li><p>ä¾èµ–æ–¹å¼</p>
<ol>
<li><p>åœ¨æ ¹build.gradleä¸­æ·»åŠ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        ...</span><br><span class="line">        maven &#123; url &apos;https://jitpack.io&apos; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å­moduleæ·»åŠ ä¾èµ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    implementation &apos;com.github.licheedev.Android-SerialPort-API:serialport:1.0.1&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>ä¿®æ”¹suè·¯å¾„</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// sué»˜è®¤è·¯å¾„ä¸º &quot;/system/bin/su&quot;</span><br><span class="line">// å¯é€šè¿‡æ­¤æ–¹æ³•ä¿®æ”¹</span><br><span class="line">SerialPort.setSuPath(&quot;/system/xbin/su&quot;);</span><br></pre></td></tr></table></figure>
<ul>
<li><p>è¿æ¥æ–¹å¼</p>
<blockquote>
<p>è¿æ¥ä¸²å£çš„æ—¶å€™éœ€è¦æŒ‡å®šä¸²å£å·ä»¥åŠæ³¢ç‰¹ç‡ï¼Œä¹‹åå®šæ—¶å¤„ç†æœºå™¨å‘é€çš„æŒ‡ä»¤ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">static void init() throws IOException &#123;</span><br><span class="line">    SerialPort.setSuPath(&quot;/system/xbin/su&quot;);</span><br><span class="line">    // è®¾ç½®ä¸²å£å·åŠæ³¢ç‰¹ç‡</span><br><span class="line">    serialPort = new SerialPort(Config.serialPort, Config.baudrate);</span><br><span class="line">    // æ¥æ”¶æŒ‡ä»¤æµ</span><br><span class="line">    inputStream = serialPort.getInputStream();</span><br><span class="line">    // å‘é€æŒ‡ä»¤æµ</span><br><span class="line">    outputStream = serialPort.getOutputStream();</span><br><span class="line">    // æ¯éš” 100ms å¤„ç†æœºå™¨ä¿¡æ¯</span><br><span class="line">    Observable.interval(100, TimeUnit.MILLISECONDS)</span><br><span class="line">            .observeOn(serialScheduler)</span><br><span class="line">            .subscribe(new Consumer&lt;Long&gt;() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void accept(Long aLong) throws Exception &#123;</span><br><span class="line">                    // å¤„ç†æœºå™¨å‘é€çš„æŒ‡ä»¤</span><br><span class="line">                    handleRecv();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>å‘æœºå™¨å‘é€æŒ‡ä»¤</p>
<blockquote>
<p>å‘æœºå™¨å‘é€æŒ‡ä»¤çš„æ—¶å€™æ˜¯ç»“åˆ Rxjava æ¥å®ç°çš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå‘æœºå™¨å‘é€æŒ‡ä»¤æ˜¯éœ€è¦æœ‰è§„å®šæ ¼å¼çš„ï¼ˆå†…éƒ¨åˆ¶å®šçš„é€šä¿¡åè®®ï¼‰ï¼Œæˆ‘ä»¬å‘é€åŠæ¥æ”¶æ•°æ®éƒ½æ˜¯ä¸€ä¸ªå­—èŠ‚æ•°ç»„ï¼Œå› æ­¤æˆ‘ä»¬æ ¼å¼æ˜¯éœ€è¦ä¸¥æ ¼æŒ‰ç…§æˆ‘ä»¬åˆ¶å®šçš„åè®®è¿›è¡Œçš„ï¼Œå¦‚ä¸‹æ˜¯å¨ƒå¨ƒæœºæŠ•å¸çš„ç®€å•ç¤ºä¾‹ï¼š</p>
</blockquote>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static ObservableSource&lt;MqttMessage&gt; addCoins(final AddCoinsDownstream msg) &#123;</span><br><span class="line">    return Observable.create(new ObservableOnSubscribe&lt;MqttMessage&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void subscribe(ObservableEmitter&lt;MqttMessage&gt; emitter) throws Exception &#123;</span><br><span class="line">            currentUser = msg.u;</span><br><span class="line">            currentHeadUrl = msg.h;</span><br><span class="line">            currentNickname = msg.nk;</span><br><span class="line">            byte[] buf = new byte[]&#123;0x11, addCoinsCmd, msg.num, msg.c, 0, 0x00, 0x00&#125;;</span><br><span class="line">            byte[] ret = sign(buf);</span><br><span class="line">            try &#123;</span><br><span class="line">                outputStream.write(ret);</span><br><span class="line">            &#125; catch (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            penddingCmd = addCoinsCmd;</span><br><span class="line">            penddingEmitter = emitter;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">            .subscribeOn(serialScheduler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>æ¥æ”¶æœºå™¨æŒ‡ä»¤<blockquote>
<p>å…³äºæ¥å—æœºå™¨æ¶ˆæ¯è¿™ä¸€å—æ˜¯æ¯éš” 100ms è¿›è¡Œçš„ï¼Œåœ¨å¤„ç†æœºå™¨æŒ‡ä»¤çš„æ—¶å€™ï¼Œé¦–å…ˆéœ€è¦è¿‡æ»¤åˆ°æ— æ•ˆçš„å­—èŠ‚ï¼Œä¹‹åå†æŒ‰ç…§æˆ‘ä»¬åˆ¶å®šçš„åè®®æ¥å¤„ç†æ¶ˆæ¯ï¼Œåˆ¤æ–­æ˜¯å¨ƒå¨ƒæœºä¸Šåˆ†ï¼Œè¿˜æ˜¯æ¸¸æˆç»“æœç­‰ä¿¡æ¯ï¼Œæœ€åå¹¶å¯¹æœºå™¨çš„æ•°æ®è¿”å›è¿›è¡Œ CRC16 æ ¡éªŒã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">static void handleRecv() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        for (; ; ) &#123;</span><br><span class="line">            int len = inputStream.available();</span><br><span class="line">            if (len &lt;= 0) &#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">            len = inputStream.read(buf, bufReadOffset, buf.length - bufReadOffset);</span><br><span class="line">            //Log.d(&quot;serialPort&quot;, String.format(&quot;read: %s&quot;, byteToHex(buf, bufReadOffset, len)));</span><br><span class="line">            bufReadOffset += len;</span><br><span class="line">            for (; ; ) &#123;</span><br><span class="line">                if (bufParseEnd == -1) &#123;</span><br><span class="line">                    for (; bufParseStart &lt; bufReadOffset; bufParseStart++) &#123;</span><br><span class="line">                        if (buf[bufParseStart] == (byte) 0xAA) &#123;</span><br><span class="line">                            bufParseEnd = bufParseStart + 1;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (bufParseEnd != -1) &#123;</span><br><span class="line">                    for (; bufParseEnd &lt; bufReadOffset; bufParseEnd++) &#123;</span><br><span class="line">                        if (buf[bufParseEnd] == (byte) 0xAA) &#123;</span><br><span class="line">                            bufParseStart = bufParseEnd;</span><br><span class="line">                            bufParseEnd += 1;</span><br><span class="line">                            continue;</span><br><span class="line">                        &#125;</span><br><span class="line">                        if (buf[bufParseEnd] == (byte) 0xDD) &#123;</span><br><span class="line">                            if (bufParseEnd - bufParseStart &gt;= 5) &#123;</span><br><span class="line">                                bufParseEnd += 1;</span><br><span class="line">                                byte size = buf[bufParseStart + 1];</span><br><span class="line">                                byte index = buf[bufParseStart + 2];</span><br><span class="line">                                byte cmd = buf[bufParseStart + 3];</span><br><span class="line">                                byte check = (byte) (size ^ index ^ cmd);</span><br><span class="line">                                for (int i = bufParseStart + 4; i &lt; bufParseEnd - 2; i++) &#123;</span><br><span class="line">                                    check ^= buf[i];</span><br><span class="line">                                &#125;</span><br><span class="line">                                if (check == buf[bufParseEnd - 2]) &#123;</span><br><span class="line">                                    //Log.d(&quot;serialPort&quot;, String.format(&quot;protocol: %s, size: %d, index: %d, cmd: %d, check: %d, data: %s&quot;, byteToHex(buf, bufParseStart, bufParseEnd - bufParseStart), size, index, cmd, check, byteToHex(buf, bufParseStart + 4, size - 3)));</span><br><span class="line">                                    switch (cmd) &#123;</span><br><span class="line">                                        // å¿ƒè·³</span><br><span class="line">                                        case heartBeatCmd: &#123;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        break;</span><br><span class="line">                                        </span><br><span class="line">                                        // ä¸Šåˆ†</span><br><span class="line">                                        case addCoinsCmd: &#123;</span><br><span class="line">                                            </span><br><span class="line">                                        &#125;</span><br><span class="line">                                        break;</span><br><span class="line">                                        </span><br><span class="line">                                        // æ¸¸æˆç»“æœ</span><br><span class="line">                                        case gameResultCmd: &#123;</span><br><span class="line">                                            boolean gift = buf[bufParseStart + 7] != 0;</span><br><span class="line">                                            IoT.sendGameResult(gift);</span><br><span class="line">                                            if (gift) &#123;</span><br><span class="line">                                                // å‘é€ç”¨æˆ·ä¿¡æ¯åˆ°ä¸­æ§ï¼Œè¿›è¡Œæ’è¡Œæ¦œæ˜¾ç¤º</span><br><span class="line">                                                WSSender.getInstance().sendUserInfo(currentUser, currentHeadUrl, currentNickname);</span><br><span class="line">                                            &#125;</span><br><span class="line">                                        &#125;</span><br><span class="line">                                        break;</span><br><span class="line">                                        default:</span><br><span class="line">                                            break;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            bufParseStart = bufParseEnd;</span><br><span class="line">                            bufParseEnd = -1;</span><br><span class="line">                            break;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                if (bufParseStart &gt;= bufReadOffset || bufParseEnd &gt;= bufReadOffset) &#123;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if (bufReadOffset == buf.length) &#123;</span><br><span class="line">                System.arraycopy(buf, bufParseStart, buf, 0, bufReadOffset - bufParseStart);</span><br><span class="line">                if (bufParseEnd != -1) &#123;</span><br><span class="line">                    bufParseEnd -= bufParseStart;</span><br><span class="line">                    bufReadOffset = bufParseEnd;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    bufReadOffset = 0;</span><br><span class="line">                &#125;</span><br><span class="line">                bufParseStart = 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<h2 id="websocket-é€šä¿¡"><a href="#websocket-é€šä¿¡" class="headerlink" title="websocket é€šä¿¡"></a>websocket é€šä¿¡</h2><p>åœ¨ä¸­æ§å’Œå¨ƒå¨ƒæœºè¿›è¡Œé€šä¿¡çš„æ–¹å¼æˆ‘ä»¬æ˜¯é€‰æ‹© websocket è¿›è¡Œçš„ã€‚ä¸­æ§ç«¯æ˜¯ serverï¼Œç„¶åå¨ƒå¨ƒæœºæ˜¯ clientã€‚</p>
<h3 id="server"><a href="#server" class="headerlink" title="server"></a>server</h3><ul>
<li><p>Server çš„å®ç°ï¼šç›®å‰ server çš„å®ç°åªæ˜¯ä¸ºäº†æ¥æ”¶å¨ƒå¨ƒæœºçš„æ•°æ®åé¦ˆï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰ä»€ä¹ˆå¤æ‚çš„æ“ä½œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class WSServer extends WebSocketServer &#123;</span><br><span class="line">    private MainActivity mainActivity;</span><br><span class="line"></span><br><span class="line">    public void setMainActivity(MainActivity mainActivity) &#123;</span><br><span class="line">        this.mainActivity = mainActivity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WSServer(InetSocketAddress address) &#123;</span><br><span class="line">        super(address);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onOpen(WebSocket conn, ClientHandshake handshake) &#123;</span><br><span class="line">        mainActivity.appendAndScrollLog(&quot;å®¢æˆ·ç«¯ï¼š&quot; + conn.getRemoteSocketAddress() + &quot; å·²è¿æ¥\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onClose(WebSocket conn, int code, String reason, boolean remote) &#123;</span><br><span class="line">        mainActivity.appendAndScrollLog(&quot;å®¢æˆ·ç«¯ï¼š&quot; + conn.getRemoteSocketAddress() + &quot; å·²æ–­å¼€\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onMessage(WebSocket conn, final String message) &#123;</span><br><span class="line">        Observable.create(new ObservableOnSubscribe&lt;SocketMessage&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void subscribe(ObservableEmitter&lt;SocketMessage&gt; emitter) throws Exception &#123;</span><br><span class="line">                final SocketMessage socketMessage = JsonIterator.deserialize(message, SocketMessage.class);</span><br><span class="line">                emitter.onNext(socketMessage);</span><br><span class="line">                emitter.onComplete();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">                .subscribeOn(Schedulers.newThread())</span><br><span class="line">                .observeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(new Consumer&lt;SocketMessage&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void accept(SocketMessage socketMessage) throws Exception &#123;</span><br><span class="line">                        if (socketMessage.getCode() == SocketMessage.TYPE_USER) &#123;</span><br><span class="line">                            // å¤¹åˆ°å¨ƒå¨ƒ</span><br><span class="line">                            </span><br><span class="line">                        &#125; else if (socketMessage.getCode() == SocketMessage.TYPE_SAY_HELLO) &#123;</span><br><span class="line">                            // è¿æ¥æ‹›å‘¼è¯­</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onError(WebSocket conn, Exception ex) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onStart() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç®€å•ä½¿ç”¨æ–¹å¼</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">appendAndScrollLog(&quot;åˆå§‹åŒ–WebSocketæœåŠ¡...\n&quot;);</span><br><span class="line">WSServer wsServer = new WSServer(18104);</span><br><span class="line">wsServer.setMainActivity(MainActivity.this);</span><br><span class="line">wsServer.setConnectionLostTimeout(5);</span><br><span class="line">wsServer.setReuseAddr(true);</span><br><span class="line">wsServer.start();</span><br><span class="line">appendAndScrollLog(&quot;åˆå§‹åŒ–WebSocketæœåŠ¡å®Œæˆ\n&quot;);</span><br></pre></td></tr></table></figure>
<h3 id="client"><a href="#client" class="headerlink" title="client"></a>client</h3><p>åœ¨ client ç«¯ï¼Œç›®å‰éœ€è¦åšçš„äººç‰©æœ‰æ–­å¼€é‡è¿ä»¥åŠæ•°æ®å‘é€çš„æ“ä½œã€‚æ–­å¼€é‡è¿çš„æ—¶å€™éœ€è¦åœ¨æ–°çš„å­çº¿ç¨‹ä¸­è¿›è¡Œï¼Œå¦åˆ™ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">You cannot initialize a reconnect out of the websocket thread. Use reconnect in another thread to insure a successful cleanup</span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œæˆ‘ä»¬æ¯æ¬¡æ–­å¼€é‡æ–°çš„æ—¶å€™æ˜¯éœ€è¦åœ¨æ–°çš„å­çº¿ç¨‹ä¸­è¿›è¡Œçš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨å‘é€æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœåˆšå¥½ socket æ²¡æœ‰è¿æ¥ä¸Šï¼Œé‚£ä¹ˆå‘é€æ•°æ®æ˜¯ä¼šæŠ¥å¼‚å¸¸çš„ï¼Œå› æ­¤æˆ‘ä»¬æœ‰æ•°æ®è¦å‘é€çš„æ—¶å€™å¦‚æœ socket æ²¡æœ‰è¿æ¥ï¼Œé‚£ä¹ˆå°±å…ˆç¼“å­˜åˆ°æœ¬åœ°ï¼Œç­‰åˆ° socket è¿æ¥ä¸Šä¹‹åå†æŠŠæ»ç•™çš„æ•°æ®ä¸€æ¬¡æ€§å‘é€å‡ºå»ã€‚</p>
<ul>
<li>ä¾èµ–é…ç½®</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">implementation &apos;org.java-websocket:Java-WebSocket:1.3.9&apos;</span><br></pre></td></tr></table></figure>
<ul>
<li>WSClient.java</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">class WSClient extends WebSocketClient &#123;</span><br><span class="line"></span><br><span class="line">    private static final String TAG = &quot;WSClient&quot;;</span><br><span class="line">    private static WSClient instance;</span><br><span class="line">    private static URI sUri;</span><br><span class="line">    private WSReceiver mWSReceiver;</span><br><span class="line">    private Disposable mReconnectDisposable;</span><br><span class="line">    private ConnectCallback mConnectCallback;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * step 1:éœ€è¦å…ˆè°ƒç”¨ï¼Œè®¾ç½® url</span><br><span class="line">     * @param uri</span><br><span class="line">     */</span><br><span class="line">    public static void setUri(URI uri)&#123;</span><br><span class="line">        sUri = uri;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * step 1:</span><br><span class="line">     * éœ€è¦å…ˆè°ƒç”¨ï¼Œè®¾ç½®æœåŠ¡ç«¯çš„ url</span><br><span class="line">     * @param ipAddress</span><br><span class="line">     * @param port</span><br><span class="line">     */</span><br><span class="line">    public static void setUri(String ipAddress,int port)&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            sUri = new URI(String.format(&quot;ws://%s:%d&quot;, ipAddress, port));</span><br><span class="line">        &#125; catch (URISyntaxException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static WSClient getInstance()&#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            synchronized (WSClient.class)&#123;</span><br><span class="line">                if (instance == null) &#123;</span><br><span class="line">                    instance = new WSClient(sUri);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * step 2ï¼šè¿æ¥ websocket</span><br><span class="line">     */</span><br><span class="line">    public void onConnect()&#123;</span><br><span class="line">        setConnectionLostTimeout(Config.instance.webSocketTimeoutSeconds);</span><br><span class="line">        setReuseAddr(true);</span><br><span class="line">        connect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private WSClient(URI server) &#123;</span><br><span class="line">        super(server);</span><br><span class="line">        // åˆå§‹åŒ–æ¶ˆæ¯å‘é€è€…</span><br><span class="line">        WSSender.getInstance().setWSClient(this);</span><br><span class="line">        // åˆå§‹åŒ–æ¶ˆæ¯æ¥æ”¶è€…</span><br><span class="line">        mWSReceiver = new WSReceiver();</span><br><span class="line">        mWSReceiver.setWSClient(this);</span><br><span class="line">        mWSReceiver.setWSSender(WSSender.getInstance());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onOpen(ServerHandshake handshakedata) &#123;</span><br><span class="line">        Log.d(TAG, &quot;onOpen: &quot;);</span><br><span class="line">        MainActivity.appendAndScrollLog(&quot;websocket å·²è¿æ¥\n&quot;);</span><br><span class="line">        Observable.just(&quot;&quot;)</span><br><span class="line">                .subscribeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(new Consumer&lt;Object&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void accept(Object o) throws Exception &#123;</span><br><span class="line">                        if (mConnectCallback != null) &#123;</span><br><span class="line">                            mConnectCallback.onWebsocketConnected();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        // æ¸…é™¤æ»ç•™çš„æ‰€æœ‰æ¶ˆæ¯</span><br><span class="line">        WSSender.getInstance().clearAllMessage();</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onMessage(String message) &#123;</span><br><span class="line">        Log.d(TAG, &quot;onMessage: &quot;);</span><br><span class="line">        mWSReceiver.handlerMessage(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onClose(int code, String reason, boolean remote) &#123;</span><br><span class="line">        Log.d(TAG, &quot;onClose: &quot;);</span><br><span class="line">        MainActivity.appendAndScrollLog(String.format(&quot;websocket å·²æ–­å¼€,æ–­å¼€åŸå› ï¼š%s\n&quot;,reason));</span><br><span class="line">        Observable.just(&quot;&quot;)</span><br><span class="line">                .subscribeOn(AndroidSchedulers.mainThread())</span><br><span class="line">                .subscribe(new Consumer&lt;Object&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void accept(Object o) throws Exception &#123;</span><br><span class="line">                        if (mConnectCallback != null) &#123;</span><br><span class="line">                            mConnectCallback.onWebsocketClosed();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        onReconnect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void onError(Exception ex) &#123;</span><br><span class="line">        if (ex != null) &#123;</span><br><span class="line">            Log.d(TAG, &quot;onError: &quot;+ex.getMessage());</span><br><span class="line">            MainActivity.appendAndScrollLog(String.format(&quot;websocket å‡ºç°é”™è¯¯,é”™è¯¯åŸå› ï¼š%s\n&quot;,ex.getMessage()));</span><br><span class="line">        &#125;</span><br><span class="line">        onReconnect();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void onReconnect() &#123;</span><br><span class="line">        if (mReconnectDisposable != null</span><br><span class="line">                &amp;&amp; !mReconnectDisposable.isDisposed())&#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        mReconnectDisposable = Observable.timer(1, TimeUnit.SECONDS)</span><br><span class="line">                .subscribeOn(Schedulers.io())</span><br><span class="line">                .subscribe(new Consumer&lt;Long&gt;() &#123;</span><br><span class="line">                    @Override</span><br><span class="line">                    public void accept(Long aLong) throws Exception &#123;</span><br><span class="line">                        Log.d(TAG, &quot;websocket reconnect&quot;);</span><br><span class="line">                        WSClient.this.reconnect();</span><br><span class="line">                        mReconnectDisposable.dispose();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setConnectCallback(ConnectCallback mConnectCallback) &#123;</span><br><span class="line">        this.mConnectCallback = mConnectCallback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public interface ConnectCallback&#123;</span><br><span class="line">        void onWebsocketConnected();</span><br><span class="line">        void onWebsocketClosed();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>WSSender.java</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by runla on 2018/10/26.</span><br><span class="line"> * æ–‡ä»¶æè¿°ï¼šWebsocket çš„æ¶ˆæ¯å‘é€è€…</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class WSSender &#123;</span><br><span class="line">    private static final String TAG = &quot;WSSender&quot;;</span><br><span class="line">    public static final int MAX_MESSAGE_COUNT = 128;</span><br><span class="line">    private static WSSender instance;</span><br><span class="line">    private WSClient mWSClientManager;</span><br><span class="line">    // æ¶ˆæ¯é˜Ÿåˆ—</span><br><span class="line">    private LinkedList&lt;String&gt; mMessageList = new LinkedList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    private WSSender() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static WSSender getInstance() &#123;</span><br><span class="line">        if (instance == null) &#123;</span><br><span class="line">            synchronized (WSSender.class) &#123;</span><br><span class="line">                if (instance == null) &#123;</span><br><span class="line">                    instance = new WSSender();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setWSClient(WSClient wsClientManager) &#123;</span><br><span class="line">        this.mWSClientManager = wsClientManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å‘é€æ‰€æœ‰æ»ç•™çš„æ¶ˆæ¯</span><br><span class="line">     */</span><br><span class="line">    public void clearAllMessage() &#123;</span><br><span class="line">        if (mWSClientManager == null) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        while (mMessageList.size() &gt; 0</span><br><span class="line">                &amp;&amp; mMessageList.getFirst() != null) &#123;</span><br><span class="line">            Log.d(TAG, &quot;sendMessage: &quot; + mMessageList.size());</span><br><span class="line">            mWSClientManager.send(mMessageList.getFirst());</span><br><span class="line">            mMessageList.removeFirst();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å‘é€æ¶ˆæ¯ï¼Œå¦‚æœæ¶ˆæ¯å‘é€ä¸å‡ºå»ï¼Œé‚£ä¹ˆå°±ç­‰åˆ°è¿æ¥æˆåŠŸåå†æ¬¡å°è¯•å‘é€</span><br><span class="line">     *</span><br><span class="line">     * @param msg</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    public boolean sendMessage(String msg) &#123;</span><br><span class="line">        if (mWSClientManager == null) &#123;</span><br><span class="line">            throw new NullPointerException(&quot;websocket client is null&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        if (TextUtils.isEmpty(msg)) &#123;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        // å°†éœ€è¦å‘é€çš„æ•°æ®æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨</span><br><span class="line">        mMessageList.addLast(msg);</span><br><span class="line"></span><br><span class="line">        while (mMessageList.size() &gt; 0</span><br><span class="line">                &amp;&amp; mMessageList.getFirst() != null) &#123;</span><br><span class="line">            Log.d(TAG, &quot;sendMessage: &quot; + mMessageList.size());</span><br><span class="line">            if (!mWSClientManager.isOpen()) &#123;</span><br><span class="line">                // å°è¯•é‡è¿</span><br><span class="line">                mWSClientManager.onReconnect();</span><br><span class="line">                break;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                mWSClientManager.send(mMessageList.getFirst());</span><br><span class="line">                mMessageList.removeFirst();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­è¶…è¿‡æˆ‘ä»¬è®¾ç½®çš„æœ€å¤§å®¹é‡ï¼Œé‚£ä¹ˆç§»é™¤æœ€å…ˆæ·»åŠ è¿›å»çš„æ¶ˆæ¯</span><br><span class="line">        if (mMessageList.size() &gt;= MAX_MESSAGE_COUNT) &#123;</span><br><span class="line">            mMessageList.removeFirst();</span><br><span class="line">        &#125;</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>WSReceiver.java</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * Created by runla on 2018/10/26.</span><br><span class="line"> * æ–‡ä»¶æè¿°ï¼šWebsocket çš„æ¶ˆæ¯æ¥æ”¶è€…</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">public class WSReceiver &#123;</span><br><span class="line">    private WSClient mWSClientManager;</span><br><span class="line">    private WSSender mWSSender;</span><br><span class="line">    private OnMessageCallback onMessageCallback;</span><br><span class="line">    public WSReceiver() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public void setWSClient(WSClient mWSClientManager) &#123;</span><br><span class="line">        this.mWSClientManager = mWSClientManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setWSSender(WSSender mWSSender) &#123;</span><br><span class="line">        this.mWSSender = mWSSender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * å¤„ç†æ¥æ”¶æ¶ˆæ¯</span><br><span class="line">     * @param message</span><br><span class="line">     */</span><br><span class="line">    public void handlerMessage(String message)&#123;</span><br><span class="line"></span><br><span class="line">        if (onMessageCallback != null)&#123;</span><br><span class="line">            onMessageCallback.onHandlerMessage(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setOnMessageCallback(OnMessageCallback onMessageCallback) &#123;</span><br><span class="line">        this.onMessageCallback = onMessageCallback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public interface OnMessageCallback&#123;</span><br><span class="line">        void onHandlerMessage(String message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>è¿æ¥è°ƒç”¨</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">appendAndScrollLog(&quot;åˆå§‹åŒ–WebSocketå®¢æˆ·ç«¯...\n&quot;);</span><br><span class="line">WSClient.setUri( Config.instance.centralServerAddress, Config.instance.webSocketPort);</span><br><span class="line">WSClient.getInstance().onConnect();</span><br><span class="line">WSClient.getInstance().setConnectCallback(MainActivity.this);</span><br><span class="line">appendAndScrollLog(&quot;åˆå§‹åŒ–WebSocketå®¢æˆ·ç«¯å®Œæˆ\n&quot;);</span><br></pre></td></tr></table></figure>
<ul>
<li>æ•°æ®å‘é€</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// æ¸…é™¤æ»ç•™çš„æ‰€æœ‰æ¶ˆæ¯</span><br><span class="line">WSSender.getInstance().clearAllMessage();</span><br><span class="line"></span><br><span class="line">// å‘é€æ¶ˆæ¯</span><br><span class="line">WSSender.getInstance().sendMessage(msg);</span><br></pre></td></tr></table></figure>
<h2 id="æ•°æ®åº“å­˜å‚¨"><a href="#æ•°æ®åº“å­˜å‚¨" class="headerlink" title="æ•°æ®åº“å­˜å‚¨"></a>æ•°æ®åº“å­˜å‚¨</h2><p>åœ¨ä¸­æ§ç«¯ï¼Œæˆ‘ä»¬éœ€è¦æ˜¾ç¤ºæ’è¡Œç‰ˆï¼Œç”¨æ¥æ˜¾ç¤ºå¤¹ä¸­å¨ƒå¨ƒæœºçš„ç”¨æˆ·åœ¨æœ¬æœˆåŠæœ¬å‘¨å¤¹ä¸­å¨ƒå¨ƒçš„æ’è¡Œï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å†ä¸­æ§ç«¯ä¿å­˜ç”¨æˆ·çš„å¤¹ä¸­å¨ƒå¨ƒæ•°é‡ä»¥åŠä¸ªäººçš„å…¶ä»–ä¿¡æ¯ï¼ŒGreenDAO æ˜¯ä¸€æ¬¾å¼€æºçš„é¢å‘ Android çš„è½»ä¾¿ã€å¿«æ·çš„ ORM æ¡†æ¶ï¼Œå°† Java å¯¹è±¡æ˜ å°„åˆ° SQLite æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬æ“ä½œæ•°æ®åº“çš„æ—¶å€™ï¼Œä¸åœ¨éœ€è¦ç¼–å†™å¤æ‚çš„ SQLè¯­å¥ï¼Œ åœ¨æ€§èƒ½æ–¹é¢ï¼ŒGreenDAO é’ˆå¯¹ Android è¿›è¡Œäº†é«˜åº¦ä¼˜åŒ–ï¼Œ æœ€å°çš„å†…å­˜å¼€é”€ ã€ä¾èµ–ä½“ç§¯å°ï¼ŒåŒæ—¶è¿˜æ˜¯æ”¯æŒæ•°æ®åº“åŠ å¯†ã€‚å…³äº GreenDAO çš„ç”¨æ³•æˆ‘å°±ä¸åœ¨è¿™é‡Œåšï¼Œå…·ä½“çš„ç”¨æ³•å¯ä»¥å‚è€ƒå®˜ç½‘ <a href="http://greenrobot.org/greendao/" target="_blank" rel="noopener">GreenDAO</a>ã€‚</p>
<hr>
<h1 id="å†™åœ¨æœ€å"><a href="#å†™åœ¨æœ€å" class="headerlink" title="å†™åœ¨æœ€å"></a>å†™åœ¨æœ€å</h1><p>å…³äºæ•´ä¸ªç³»ç»Ÿçš„æ¶æ„æ­å»ºè¿‡ç¨‹ä¸­é‡åˆ°äº†å¥½å¤šå‘ï¼Œä»¥ä¸Šæ˜¯æˆ‘ä¸ºè¿™ä¸ªé¡¹ç›®æä¾›çš„éƒ¨åˆ†è§£å†³æ–¹æ¡ˆï¼Œå½“å‰å…¨éƒ¨çš„æ˜¯ä¸å¯èƒ½éƒ½æ”¾å†™å‡ºæ¥çš„ï¼Œæ­¤é¡¹ç›®ç›®å‰å·²ç»åœ¨è¥¿å®‰å’Œæˆéƒ½ç­‰åœ°éƒ½æœ‰é—¨åº—ç‚¹äº†ï¼Œæ®åé¦ˆï¼Œåˆ©æ¶¦æå¤§ï¼Œä¸è¿‡è¿™ç§ç±»å‹çš„é¡¹ç›®çº¢åˆ©æœŸä¸ä¼šå¤ªé•¿ï¼Œä¼°è®¡ä¹Ÿæ˜¯ 2~3 å¹´å·¦å³å§ã€‚å¦‚æœæœ‰éœ€è¦æˆ‘ä»¬ä¸º <strong>å£çº¢æœºå¼€å‘</strong> æˆ–è€…æ˜¯ <strong>å¨ƒå¨ƒæœºå¼€å‘</strong> æä¾›è§£å†³æ–¹æ¡ˆçš„ï¼Œå¯ä»¥<a href="https://www.talkmoney.cn/" target="_blank" rel="noopener">è”ç³»æˆ‘ä»¬</a>ï¼Œç›®å‰æˆ‘ä»¬åœ¨è¿™ä¸ªæ–¹é¢å·²ç»æœ‰ç›¸å¯¹è¾ƒä¸ºæˆç†Ÿçš„è§£å†³æ–¹æ¡ˆäº†ã€‚</p>

    </div>
  </div>
  
    <div class="copy-right">
      <div class="markdown-body">
        <blockquote>
        
        
          æœ¬æ–‡ä½œè€… : GODBMW <br>
        
        åŸæ–‡é“¾æ¥ : <a href>http://yoursite.com/2019/02/25/Android-æŠ–éŸ³çˆ†çº¢çš„å£çº¢æŒ‘æˆ˜çˆ¬å‘æ€»ç»“/</a><br>
        ç‰ˆæƒå£°æ˜ : æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼
        </blockquote>
      </div>
    </div>
  
  
  
    <div class="social-share" style="margin-top: -2rem" data-wechat-qrcode-title="<p>å¾®ä¿¡æ‰«ä¸€æ‰«</p>" data-wechat-qrcode-helper="<p>å¾®ä¿¡å³ä¸Šè§’, æ‰«ä¸€æ‰«åˆ†äº«</p>" data-sites="qzone, qq, weibo, wechat, douban, google, facebook, twitter">
  <span style="color: #6b7487; font-size: 1.4rem;">åˆ†äº«åˆ°: </span>
</div>
<script src="https://cdn.bootcss.com/social-share.js/1.0.16/js/social-share.min.js" async></script>
  

  
    <div id="reward">
  
    <p id="reward-meta">çŸ¥è¯† & æƒ…æ€€ | äºŒè€…å…¼å¾—</p>
  
  <button id="reward-btn">
    
    <span>æŠ•é£Ÿ</span>
  </button>
  <div id="reward-qrcode">
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/images/wechat.png" alt="å¾®ä¿¡æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ">
        <p class="qrcode-meta">å¾®ä¿¡æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ</p>
      </div>
    
      <div class="reward-qrcode--container">
        <img class="qrcode-img" src="/images/alipay.png" alt="æ”¯ä»˜å®æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ">
        <p class="qrcode-meta">æ”¯ä»˜å®æ‰«ä¸€æ‰«, å‘æˆ‘æŠ•é£Ÿ</p>
      </div>
    
  </div>

</div>

<script>
  (() => {
    let button = document.querySelector('#reward-btn'),
      qrcode = document.querySelector('#reward-qrcode'),
      display = false;
    
    button.addEventListener('click', () => {
      qrcode.style.display = display ? 'none' : 'block'
      display = !display
    }, false)
  })()
</script>
  

  <div class="article-footer">
    <div class="article-meta pull-left">
      <span>
        
          <i class="iconfont icon-06tags"></i>æ ‡ç­¾: 
          
          <span class="span--tag">
            <a href="/tags/Android-å£çº¢æœº-æ€»ç»“/">
              #Android,å£çº¢æœº,æ€»ç»“
            </a>
          </span>
          
        
      </span>
    </div>
    <div class="article-meta pull-right">
    </div>
  </div>
</div>


  <aside id="sidebar">
    <p id="sidebar-header"></p>
    <ol id="sidebar-toc"></ol>
  </aside>
  <script async>setTimeout(generateToc, 10);</script>


  <nav class="post-navigation">
    
    
      <div class="nav-next">
        ä¸‹ä¸€ç¯‡:
        <a href="/2019/02/25/RxPermissions æºç è§£æä¹‹ä¸¾ä¸€åä¸‰/" target="_self">RxPermissions æºç è§£æä¹‹ä¸¾ä¸€åä¸‰</a>
        <i class="iconfont icon-next"></i>
      </div>
    
  </nav>

  
    <a href="#comment" class="comment-anchor"></a>
<div class="comment-title"><i class="iconfont icon-footprint"></i> ç•™ä¸‹è¶³è¿¹ <i class="iconfont icon-footprint"></i></div>
<div id="vcomments"></div>

<script defer>
  if( true ) {
    let path = getRealPath()
    new Valine({
      el: "#vcomments",
      appId: "Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz",
      appKey: "WaR7nrzhliHj9aVwdQzkdlGd",
      notify: false,
      verify: false,
      avatar: "robohash",
      placeholder: "æ­£ç¡®å¡«å†™é‚®ç®±, æ‰èƒ½åŠæ—¶æ”¶åˆ°å›å¤å“¦â™ª(^âˆ‡^*)",
      path
    });
  }
</script>
   

  
    <script defer>
const valineAPI = (() => {
  try {
    AV.init("Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz", "WaR7nrzhliHj9aVwdQzkdlGd");
  } catch(error) {}
  const isExist = (identity) => {
    identity = identity || getRealPath();
    let query = new AV.Query('Timer');
    return new Promise((resolve, reject) => {
      query.equalTo("identity", identity);
      query.find().then(results => {
        resolve(results.length > 0);
      }, error => reject(error));
    })
  }

  const _get = (identity) => {
    let query = null;
    if(identity && identity instanceof Array){
      let querys = [];
      for(let i = 0; i < identity.length; ++i) {
        querys[i] = new AV.Query('Timer');
        querys[i].equalTo('identity', identity[i]);
      }
      query = AV.Query.or.apply(null ,querys);
    } else {
      identity = identity || getRealPath();
      query = new AV.Query("Timer");
      query.equalTo("identity", identity);
    }

    return new Promise((resolve, reject) => {
      query.find()
      .then(results => resolve(results))
      .catch(error => reject(error))
    })
  }

  const create = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let Todo = AV.Object.extend('Timer');
      let todo = new Todo();
      todo.set("times", 1);
      todo.set("identity", identity);
      todo.save().then(res => resolve(true), error => reject(error));
    })
  }

  const update = (identity) => {
    identity = identity || getRealPath();
    return new Promise((resolve, reject) => {
      let query = new AV.Query('Timer');
      query.equalTo("identity", identity);
      query.find().then(todos => {
        todos.forEach(todo => {
          todo.set("times", todo.attributes.times + 1);
        });
        return AV.Object.saveAll(todos);
      }).then(todos => resolve(true), error => reject(error));
    })
  }

  return {
    isExist,
    _get,
    update,
    create
  }
})()

const calcAndWriteTimes = () => {
  let isPost = true;

  let timerAllDOM = document.querySelectorAll(".article-timer");

  if(isPost) {
    let identity = timerAllDOM[0].getAttribute("data-identity");
    valineAPI.isExist(identity)
    .then(exist => {
      if(exist) {
        return valineAPI.update(identity);
      }
      return new Promise(resolve => resolve(true));
    })
    .then( succuess => valineAPI._get(identity))
    .then( result => timerAllDOM[0].innerText = result[0].attributes.times)
    .catch(error => console.log(error.message))
    return ;
  }

  let timerDOMCache = {};

  for(let timerDOM of timerAllDOM) {
    let identity = timerDOM.getAttribute("data-identity");
    if(timerDOMCache.hasOwnProperty(identity)){
      timerDOMCache[identity].dom.push(timerDOM);
    }else{
      timerDOMCache[identity] = {
        dom: [timerDOM],
        times: undefined
      };
    }
  }

  let identities = Object.keys(timerDOMCache);
  valineAPI._get(identities).then(results => {
    for(let result of results) {
      let {identity, times} = result.attributes;
      timerDOMCache[identity].times = times;
      timerDOMCache[identity].dom.map(item => item.innerText = times);
    }
    for(let identity of identities) {
      if(timerDOMCache[identity].times){
        continue;
      }
      timerDOMCache[identity].dom.map(item => item.innerText = 1);
      valineAPI.create(identity);
    }
  }).catch(error => console.log(error.message))
}

if(true){
  calcAndWriteTimes();
}
</script>
   

</div>


      <footer>
  <p class="site-info">
    åšå®¢å·²èŒèŒå“’è¿è¡Œ<span id="time-to-now"></span><span class="my-face">(â—'â—¡'â—)ï¾‰â™¥</span>
    <br>
    Theme - <a href="https://github.com/dongyuanxin/theme-bmw">BMW</a> | Made With ğŸ’— | Powered by <a href="https://godbmw.com/">GodBMW</a>
    <br>
    
  </p>
</footer>



<script>
const timeToNowDOM = document.querySelector("#time-to-now");
const startTimestamp = new Date(2018, 1, 10).getTime();

const updateTimeStr = () => {
  let offset = parseInt(
      (new Date().getTime() - startTimestamp) / 1000,
      10
    ),
    day = Math.floor(offset / 86400),
    hour = Math.floor((offset % 86400) / 3600),
    minute = Math.floor(((offset % 86400) % 3600) / 60),
    second = Math.floor(((offset % 86400) % 3600) % 60);
  timeToNowDOM.innerHTML =
    day + "å¤©" + hour + "å°æ—¶" + minute + "åˆ†é’Ÿ" + second + "ç§’";
  setTimeout(updateTimeStr, 500);
}

setTimeout(updateTimeStr, 500);
</script>


      <div class="back-to-top hidden">
  <span>
    <i class="iconfont icon-60"></i><span></span>%
  </span>
</div>

<script>
const updateIconToTop = percent => {
  let dom = document.querySelector(".back-to-top span span");
  dom.innerText = percent;
  if(percent < 1) {
    document.querySelector(".back-to-top").className = "back-to-top hidden";
  } else {
    document.querySelector(".back-to-top").className = "back-to-top";
  }
}

const handleScoll = () => {
  let isRunning = false;
  return () => {
    if (isRunning) return;
    isRunning = true;
    window.requestAnimationFrame(timestamp => {
      let scrollTop =
          document.documentElement.scrollTop || document.body.scrollTop,
        scrollHeight =
          document.documentElement.scrollHeight ||
          document.body.scrollHeight,
        clientHeight =
          document.documentElement.clientHeight ||
          document.body.clientHeight;
      isRunning = false;
      if (scrollTop <= 1) {
        updateIconToTop(0);
        return;
      }
      if (scrollTop + clientHeight >= scrollHeight) {
        updateIconToTop(100);
      } else {
        updateIconToTop(parseInt(
          100 * scrollTop / (scrollHeight - clientHeight),
          10
        ));
      }
    });
  };
}

const backToTop = () => {
  let scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop,
    delay = 10,
    time = 200;
  if (scrollTop <= 20) {
    document.documentElement.scrollTop = 0;
    document.body.scrollTop = 0;
    return;
  }
  let step = Math.ceil(scrollTop * delay / time);
  let timer = setInterval(() => {
    scrollTop =
      document.documentElement.scrollTop || document.body.scrollTop;
    if (scrollTop - step <= 0) {
      document.documentElement.scrollTop = 0;
      document.body.scrollTop = 0;
      clearInterval(timer);
    } else {
      document.documentElement.scrollTop = scrollTop - step;
      document.body.scrollTop = scrollTop - step;
    }
  }, delay);
}

document.addEventListener("scroll", handleScoll(), false);

document.querySelector(".back-to-top").addEventListener("click", backToTop, false);

</script>

    </div>

    
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
<script>
  (() => {
    const mathjaxConfig = {
      showProcessingMessages: false, //å…³é—­jsåŠ è½½è¿‡ç¨‹ä¿¡æ¯
      messageStyle: "none", //ä¸æ˜¾ç¤ºä¿¡æ¯
      jax: ["input/TeX", "output/HTML-CSS"],
      tex2jax: {
        inlineMath: [["$", "$"], ["\\(", "\\)"]], //è¡Œå†…å…¬å¼é€‰æ‹©ç¬¦
        displayMath: [["$$", "$$"], ["\\[", "\\]"]], //æ®µå†…å…¬å¼é€‰æ‹©ç¬¦
        skipTags: ["script", "noscript", "style", "textarea", "pre", "code", "a"] //é¿å¼€æŸäº›æ ‡ç­¾
      },
      "HTML-CSS": {
        availableFonts: ["STIX", "TeX"], //å¯é€‰å­—ä½“
        showMathMenu: false //å…³é—­å³å‡»èœå•æ˜¾ç¤º
      }
    }

    let mathjaxInterval = setInterval(() => {
      if(!window.MathJax){
        return;
      }
      window.MathJax.Hub.Config(mathjaxConfig)
      window.MathJax.Hub.Queue(["Typeset", MathJax.Hub, document.getElementById('app')])

      clearInterval(mathjaxInterval)
    }, 10)    
  })()
</script>
    

    <script src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js" async></script>
<script async>
  let fancyTimer = setInterval(function(){
    if(!window.$){
      return;
    }
    $(document).ready(function() {
      $(".post img").each(function () {
        if($(this).parent().get(0).tagName.toLowerCase() === "a") {
          return;
        }
        // $(this).attr("data-fancybox", "gallery"); // if you add 'data-fancybox', img will display after showed
        var element = document.createElement("a");
        $(element).attr("data-fancybox", "gallery");
        $(element).attr("href", $(this).attr("src"));
        $(this).wrap(element);
      });
      
      clearInterval(fancyTimer);
    });
  }, 10);
</script>

    
  </body>

</html>
